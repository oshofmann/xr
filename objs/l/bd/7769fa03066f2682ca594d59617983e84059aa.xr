var __xr_tmp = [
"<span class=\"comment\">/* Management of a process's keyrings</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Copyright (C) 2004-2005, 2008 Red Hat, Inc. All Rights Reserved.</span>", 
"<span class=\"comment\"> * Written by David Howells (dhowells@redhat.com)</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * This program is free software; you can redistribute it and/or</span>", 
"<span class=\"comment\"> * modify it under the terms of the GNU General Public License</span>", 
"<span class=\"comment\"> * as published by the Free Software Foundation; either version</span>", 
"<span class=\"comment\"> * 2 of the License, or (at your option) any later version.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#module\">module</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#init\">init</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#sched\">sched</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#keyctl\">keyctl</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#fs\">fs</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#err\">err</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#mutex\">mutex</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#security\">security</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#user_namespace\">user_namespace</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#asm\">asm</a>/<a class=\"id\" href=\"#uaccess\">uaccess</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> \"internal.h\"", 
"", 
"<span class=\"comment\">/* session keyring create vs join semaphore */</span>", 
"static <a class=\"id\" href=\"#DEFINE_MUTEX\">DEFINE_MUTEX</a>(<a class=\"id\" href=\"#key_session_mutex\">key_session_mutex</a>);", 
"", 
"<span class=\"comment\">/* user keyring creation semaphore */</span>", 
"static <a class=\"id\" href=\"#DEFINE_MUTEX\">DEFINE_MUTEX</a>(<a class=\"id\" href=\"#key_user_keyring_mutex\">key_user_keyring_mutex</a>);", 
"", 
"<span class=\"comment\">/* the root user's tracking struct */</span>", 
"struct <a class=\"id\" href=\"#key_user\">key_user</a> <a class=\"id\" href=\"#root_key_user\">root_key_user</a> = {", 
"<span class=\"ts\"/>.<a class=\"id\" href=\"#usage\">usage</a><span class=\"ts\"/><span class=\"ts\"/>= <a class=\"id\" href=\"#ATOMIC_INIT\">ATOMIC_INIT</a>(3),", 
"<span class=\"ts\"/>.<a class=\"id\" href=\"#cons_lock\">cons_lock</a><span class=\"ts\"/>= <a class=\"id\" href=\"#__MUTEX_INITIALIZER\">__MUTEX_INITIALIZER</a>(<a class=\"id\" href=\"#root_key_user\">root_key_user</a>.<a class=\"id\" href=\"#cons_lock\">cons_lock</a>),", 
"<span class=\"ts\"/>.<a class=\"id\" href=\"#lock\">lock</a><span class=\"ts\"/><span class=\"ts\"/>= <a class=\"id\" href=\"#__SPIN_LOCK_UNLOCKED\">__SPIN_LOCK_UNLOCKED</a>(<a class=\"id\" href=\"#root_key_user\">root_key_user</a>.<a class=\"id\" href=\"#lock\">lock</a>),", 
"<span class=\"ts\"/>.<a class=\"id\" href=\"#nkeys\">nkeys</a><span class=\"ts\"/><span class=\"ts\"/>= <a class=\"id\" href=\"#ATOMIC_INIT\">ATOMIC_INIT</a>(2),", 
"<span class=\"ts\"/>.<a class=\"id\" href=\"#nikeys\">nikeys</a><span class=\"ts\"/><span class=\"ts\"/>= <a class=\"id\" href=\"#ATOMIC_INIT\">ATOMIC_INIT</a>(2),", 
"<span class=\"ts\"/>.<a class=\"id\" href=\"#uid\">uid</a><span class=\"ts\"/><span class=\"ts\"/>= 0,", 
"<span class=\"ts\"/>.<a class=\"id\" href=\"#user_ns\">user_ns</a><span class=\"ts\"/>= &amp;<a class=\"id\" href=\"#init_user_ns\">init_user_ns</a>,", 
"};", 
"", 
"<span class=\"comment\">/*****************************************************************************/</span>", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * install user and user session keyrings for a particular UID</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#install_user_keyrings\">install_user_keyrings</a>(void)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#user_struct\">user_struct</a> *<a class=\"id\" href=\"#user\">user</a>;", 
"<span class=\"ts\"/>const struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#cred\">cred</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>, *<a class=\"id\" href=\"#session_keyring\">session_keyring</a>;", 
"<span class=\"ts\"/>char <a class=\"id\" href=\"#buf\">buf</a>[20];", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#cred\">cred</a> = <a class=\"id\" href=\"#current_cred\">current_cred</a>();", 
"<span class=\"ts\"/><a class=\"id\" href=\"#user\">user</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#user\">user</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kenter\">kenter</a>(\"%p{%u}\", <a class=\"id\" href=\"#user\">user</a>, <a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid\">uid</a>);", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#kleave\">kleave</a>(\" = 0 [exist]\");", 
"<span class=\"ts\"/><span class=\"ts\"/>return 0;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mutex_lock\">mutex_lock</a>(&amp;<a class=\"id\" href=\"#key_user_keyring_mutex\">key_user_keyring_mutex</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = 0;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* get the UID-specific keyring</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * - there may be one in existence already as it may have been</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> *   pinned by a session, but the user_struct pointing to it</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> *   may have been destroyed by setuid */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#sprintf\">sprintf</a>(<a class=\"id\" href=\"#buf\">buf</a>, \"_uid.%u\", <a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid\">uid</a>);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#uid_keyring\">uid_keyring</a> = <a class=\"id\" href=\"#find_keyring_by_name\">find_keyring_by_name</a>(<a class=\"id\" href=\"#buf\">buf</a>, <a class=\"id\" href=\"#true\">true</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#uid_keyring\">uid_keyring</a> = <a class=\"id\" href=\"#keyring_alloc\">keyring_alloc</a>(<a class=\"id\" href=\"#buf\">buf</a>, <a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid\">uid</a>, (<a class=\"id\" href=\"#gid_t\">gid_t</a>) -1,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>    <a class=\"id\" href=\"#cred\">cred</a>, <a class=\"id\" href=\"#KEY_ALLOC_IN_QUOTA\">KEY_ALLOC_IN_QUOTA</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>    <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* get a default session keyring (which might also exist</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * already) */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#sprintf\">sprintf</a>(<a class=\"id\" href=\"#buf\">buf</a>, \"_uid_ses.%u\", <a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid\">uid</a>);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#session_keyring\">session_keyring</a> = <a class=\"id\" href=\"#find_keyring_by_name\">find_keyring_by_name</a>(<a class=\"id\" href=\"#buf\">buf</a>, <a class=\"id\" href=\"#true\">true</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#session_keyring\">session_keyring</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#session_keyring\">session_keyring</a> =", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#keyring_alloc\">keyring_alloc</a>(<a class=\"id\" href=\"#buf\">buf</a>, <a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid\">uid</a>, (<a class=\"id\" href=\"#gid_t\">gid_t</a>) -1,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>      <a class=\"id\" href=\"#cred\">cred</a>, <a class=\"id\" href=\"#KEY_ALLOC_IN_QUOTA\">KEY_ALLOC_IN_QUOTA</a>, <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#session_keyring\">session_keyring</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#session_keyring\">session_keyring</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error_release\">error_release</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* we install a link from the user session keyring to</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/> * the user keyring */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#key_link\">key_link</a>(<a class=\"id\" href=\"#session_keyring\">session_keyring</a>, <a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error_release_both\">error_release_both</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* install the keyrings */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid_keyring\">uid_keyring</a> = <a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a> = <a class=\"id\" href=\"#session_keyring\">session_keyring</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mutex_unlock\">mutex_unlock</a>(&amp;<a class=\"id\" href=\"#key_user_keyring_mutex\">key_user_keyring_mutex</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kleave\">kleave</a>(\" = 0\");", 
"<span class=\"ts\"/>return 0;", 
"", 
"<a class=\"id\" href=\"#error_release_both\">error_release_both</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_put\">key_put</a>(<a class=\"id\" href=\"#session_keyring\">session_keyring</a>);", 
"<a class=\"id\" href=\"#error_release\">error_release</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_put\">key_put</a>(<a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>);", 
"<a class=\"id\" href=\"#error\">error</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mutex_unlock\">mutex_unlock</a>(&amp;<a class=\"id\" href=\"#key_user_keyring_mutex\">key_user_keyring_mutex</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kleave\">kleave</a>(\" = %d\", <a class=\"id\" href=\"#ret\">ret</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * install a fresh thread keyring directly to new credentials</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#install_thread_keyring_to_cred\">install_thread_keyring_to_cred</a>(struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#new\">new</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#keyring\">keyring</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#keyring\">keyring</a> = <a class=\"id\" href=\"#keyring_alloc\">keyring_alloc</a>(\"_tid\", <a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#uid\">uid</a>, <a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#gid\">gid</a>, <a class=\"id\" href=\"#new\">new</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#KEY_ALLOC_QUOTA_OVERRUN\">KEY_ALLOC_QUOTA_OVERRUN</a>, <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a> = <a class=\"id\" href=\"#keyring\">keyring</a>;", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * install a fresh thread keyring, discarding the old one</span>", 
"<span class=\"comment\"> */</span>", 
"static int <a class=\"id\" href=\"#install_thread_keyring\">install_thread_keyring</a>(void)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#new\">new</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a> = <a class=\"id\" href=\"#prepare_creds\">prepare_creds</a>();", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#new\">new</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#ENOMEM\">ENOMEM</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#BUG_ON\">BUG_ON</a>(<a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_thread_keyring_to_cred\">install_thread_keyring_to_cred</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#abort_creds\">abort_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#commit_creds\">commit_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * install a process keyring directly to a credentials struct</span>", 
"<span class=\"comment\"> * - returns -EEXIST if there was already a process keyring, 0 if one installed,</span>", 
"<span class=\"comment\"> *   and other -ve on any other error</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#install_process_keyring_to_cred\">install_process_keyring_to_cred</a>(struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#new\">new</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#keyring\">keyring</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#EEXIST\">EEXIST</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#keyring\">keyring</a> = <a class=\"id\" href=\"#keyring_alloc\">keyring_alloc</a>(\"_pid\", <a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#uid\">uid</a>, <a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#gid\">gid</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>, <a class=\"id\" href=\"#KEY_ALLOC_QUOTA_OVERRUN\">KEY_ALLOC_QUOTA_OVERRUN</a>, <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock_irq\">spin_lock_irq</a>(&amp;<a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#lock\">lock</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a> = <a class=\"id\" href=\"#keyring\">keyring</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#keyring\">keyring</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = 0;", 
"<span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = -<a class=\"id\" href=\"#EEXIST\">EEXIST</a>;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock_irq\">spin_unlock_irq</a>(&amp;<a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#lock\">lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_put\">key_put</a>(<a class=\"id\" href=\"#keyring\">keyring</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * make sure a process keyring is installed</span>", 
"<span class=\"comment\"> * - we</span>", 
"<span class=\"comment\"> */</span>", 
"static int <a class=\"id\" href=\"#install_process_keyring\">install_process_keyring</a>(void)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#new\">new</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a> = <a class=\"id\" href=\"#prepare_creds\">prepare_creds</a>();", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#new\">new</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#ENOMEM\">ENOMEM</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_process_keyring_to_cred\">install_process_keyring_to_cred</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#abort_creds\">abort_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a> != -<a class=\"id\" href=\"#EEXIST\">EEXIST</a> ?: 0;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#commit_creds\">commit_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * install a session keyring directly to a credentials struct</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#install_session_keyring_to_cred\">install_session_keyring_to_cred</a>(struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#cred\">cred</a>, struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#keyring\">keyring</a>)", 
"{", 
"<span class=\"ts\"/>unsigned long <a class=\"id\" href=\"#flags\">flags</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#old\">old</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#might_sleep\">might_sleep</a>();", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* create an empty session keyring */</span>", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#keyring\">keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#flags\">flags</a> = <a class=\"id\" href=\"#KEY_ALLOC_QUOTA_OVERRUN\">KEY_ALLOC_QUOTA_OVERRUN</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#flags\">flags</a> = <a class=\"id\" href=\"#KEY_ALLOC_IN_QUOTA\">KEY_ALLOC_IN_QUOTA</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#keyring\">keyring</a> = <a class=\"id\" href=\"#keyring_alloc\">keyring_alloc</a>(\"_ses\", <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#uid\">uid</a>, <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#gid\">gid</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#cred\">cred</a>, <a class=\"id\" href=\"#flags\">flags</a>, <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>);", 
"<span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#keyring\">keyring</a>-><a class=\"id\" href=\"#usage\">usage</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* install the keyring */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock_irq\">spin_lock_irq</a>(&amp;<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#lock\">lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#old\">old</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#rcu_assign_pointer\">rcu_assign_pointer</a>(<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>, <a class=\"id\" href=\"#keyring\">keyring</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock_irq\">spin_unlock_irq</a>(&amp;<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#lock\">lock</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* we're using RCU on the pointer, but there's no point synchronising</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * on it if it didn't previously point to anything */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#old\">old</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#synchronize_rcu\">synchronize_rcu</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_put\">key_put</a>(<a class=\"id\" href=\"#old\">old</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * install a session keyring, discarding the old one</span>", 
"<span class=\"comment\"> * - if a keyring is not supplied, an empty one is invented</span>", 
"<span class=\"comment\"> */</span>", 
"static int <a class=\"id\" href=\"#install_session_keyring\">install_session_keyring</a>(struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#keyring\">keyring</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#new\">new</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a> = <a class=\"id\" href=\"#prepare_creds\">prepare_creds</a>();", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#new\">new</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#ENOMEM\">ENOMEM</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_session_keyring_to_cred\">install_session_keyring_to_cred</a>(<a class=\"id\" href=\"#new\">new</a>, <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#abort_creds\">abort_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#commit_creds\">commit_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"}", 
"", 
"<span class=\"comment\">/*****************************************************************************/</span>", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * the filesystem user ID changed</span>", 
"<span class=\"comment\"> */</span>", 
"void <a class=\"id\" href=\"#key_fsuid_changed\">key_fsuid_changed</a>(struct <a class=\"id\" href=\"#task_struct\">task_struct</a> *<a class=\"id\" href=\"#tsk\">tsk</a>)", 
"{", 
"<span class=\"ts\"/><span class=\"comment\">/* update the ownership of the thread keyring */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#BUG_ON\">BUG_ON</a>(!<a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#down_write\">down_write</a>(&amp;<a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>-><a class=\"id\" href=\"#uid\">uid</a> = <a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#fsuid\">fsuid</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#up_write\">up_write</a>(&amp;<a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"<span class=\"ts\"/>}", 
"", 
"} <span class=\"comment\">/* end key_fsuid_changed() */</span>", 
"", 
"<span class=\"comment\">/*****************************************************************************/</span>", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * the filesystem group ID changed</span>", 
"<span class=\"comment\"> */</span>", 
"void <a class=\"id\" href=\"#key_fsgid_changed\">key_fsgid_changed</a>(struct <a class=\"id\" href=\"#task_struct\">task_struct</a> *<a class=\"id\" href=\"#tsk\">tsk</a>)", 
"{", 
"<span class=\"ts\"/><span class=\"comment\">/* update the ownership of the thread keyring */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#BUG_ON\">BUG_ON</a>(!<a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#down_write\">down_write</a>(&amp;<a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>-><a class=\"id\" href=\"#gid\">gid</a> = <a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#fsgid\">fsgid</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#up_write\">up_write</a>(&amp;<a class=\"id\" href=\"#tsk\">tsk</a>-><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"<span class=\"ts\"/>}", 
"", 
"} <span class=\"comment\">/* end key_fsgid_changed() */</span>", 
"", 
"<span class=\"comment\">/*****************************************************************************/</span>", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * search only my process keyrings for the first matching key</span>", 
"<span class=\"comment\"> * - we use the supplied match function to see if the description (or other</span>", 
"<span class=\"comment\"> *   feature of interest) matches</span>", 
"<span class=\"comment\"> * - we return -EAGAIN if we didn't find any matching key</span>", 
"<span class=\"comment\"> * - we return -ENOKEY if we found only negative matching keys</span>", 
"<span class=\"comment\"> */</span>", 
"<a class=\"id\" href=\"#key_ref_t\">key_ref_t</a> <a class=\"id\" href=\"#search_my_process_keyrings\">search_my_process_keyrings</a>(struct <a class=\"id\" href=\"#key_type\">key_type</a> *<a class=\"id\" href=\"#type\">type</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>     const void *<a class=\"id\" href=\"#description\">description</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>     <a class=\"id\" href=\"#key_match_func_t\">key_match_func_t</a> <a class=\"id\" href=\"#match\">match</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>     const struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#cred\">cred</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref_t\">key_ref_t</a> <a class=\"id\" href=\"#key_ref\">key_ref</a>, <a class=\"id\" href=\"#ret\">ret</a>, <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* we want to return -EAGAIN or -ENOKEY if any of the keyrings were</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * searchable, but we failed to find a key or we found a negative key;</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * otherwise we want to return a sample error (probably -EACCES) if</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * none of the keyrings were searchable</span>", 
"<span class=\"comment\"><span class=\"ts\"/> *</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * in terms of priority: success &gt; -ENOKEY &gt; -EAGAIN &gt; other error</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#EAGAIN\">EAGAIN</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* search the thread keyring first */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#keyring_search_aux\">keyring_search_aux</a>(", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>, 1),", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#cred\">cred</a>, <a class=\"id\" href=\"#type\">type</a>, <a class=\"id\" href=\"#description\">description</a>, <a class=\"id\" href=\"#match\">match</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#found\">found</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>switch (<a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#EAGAIN\">EAGAIN</a>: <span class=\"comment\">/* no key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>: <span class=\"comment\">/* negative key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>default:", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* search the process keyring second */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#keyring_search_aux\">keyring_search_aux</a>(", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a>, 1),", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#cred\">cred</a>, <a class=\"id\" href=\"#type\">type</a>, <a class=\"id\" href=\"#description\">description</a>, <a class=\"id\" href=\"#match\">match</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#found\">found</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>switch (<a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#EAGAIN\">EAGAIN</a>: <span class=\"comment\">/* no key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>: <span class=\"comment\">/* negative key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>default:", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* search the session keyring */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#rcu_read_lock\">rcu_read_lock</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#keyring_search_aux\">keyring_search_aux</a>(", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#rcu_dereference\">rcu_dereference</a>(", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>     <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>),", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>     1),", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#cred\">cred</a>, <a class=\"id\" href=\"#type\">type</a>, <a class=\"id\" href=\"#description\">description</a>, <a class=\"id\" href=\"#match\">match</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#rcu_read_unlock\">rcu_read_unlock</a>();", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#found\">found</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>switch (<a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#EAGAIN\">EAGAIN</a>: <span class=\"comment\">/* no key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>: <span class=\"comment\">/* negative key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>default:", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"comment\">/* or search the user-session keyring */</span>", 
"<span class=\"ts\"/>else if (<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#keyring_search_aux\">keyring_search_aux</a>(", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>, 1),", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#cred\">cred</a>, <a class=\"id\" href=\"#type\">type</a>, <a class=\"id\" href=\"#description\">description</a>, <a class=\"id\" href=\"#match\">match</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#found\">found</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>switch (<a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#EAGAIN\">EAGAIN</a>: <span class=\"comment\">/* no key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>: <span class=\"comment\">/* negative key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>default:", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* no key - decide on the error we're going to go for */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ret\">ret</a> ? <a class=\"id\" href=\"#ret\">ret</a> : <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<a class=\"id\" href=\"#found\">found</a>:", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"}", 
"", 
"<span class=\"comment\">/*****************************************************************************/</span>", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * search the process keyrings for the first matching key</span>", 
"<span class=\"comment\"> * - we use the supplied match function to see if the description (or other</span>", 
"<span class=\"comment\"> *   feature of interest) matches</span>", 
"<span class=\"comment\"> * - we return -EAGAIN if we didn't find any matching key</span>", 
"<span class=\"comment\"> * - we return -ENOKEY if we found only negative matching keys</span>", 
"<span class=\"comment\"> */</span>", 
"<a class=\"id\" href=\"#key_ref_t\">key_ref_t</a> <a class=\"id\" href=\"#search_process_keyrings\">search_process_keyrings</a>(struct <a class=\"id\" href=\"#key_type\">key_type</a> *<a class=\"id\" href=\"#type\">type</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  const void *<a class=\"id\" href=\"#description\">description</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#key_match_func_t\">key_match_func_t</a> <a class=\"id\" href=\"#match\">match</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  const struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#cred\">cred</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#request_key_auth\">request_key_auth</a> *<a class=\"id\" href=\"#rka\">rka</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref_t\">key_ref_t</a> <a class=\"id\" href=\"#key_ref\">key_ref</a>, <a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#EACCES\">EACCES</a>), <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#might_sleep\">might_sleep</a>();", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#search_my_process_keyrings\">search_my_process_keyrings</a>(<a class=\"id\" href=\"#type\">type</a>, <a class=\"id\" href=\"#description\">description</a>, <a class=\"id\" href=\"#match\">match</a>, <a class=\"id\" href=\"#cred\">cred</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#found\">found</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* if this process has an instantiation authorisation key, then we also</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * search the keyrings of the process mentioned there</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * - we don't permit access to request_key auth keys via this method</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a> &&", 
"<span class=\"ts\"/>    <a class=\"id\" href=\"#cred\">cred</a> == <a class=\"id\" href=\"#current_cred\">current_cred</a>() &&", 
"<span class=\"ts\"/>    <a class=\"id\" href=\"#type\">type</a> != &amp;<a class=\"id\" href=\"#key_type_request_key_auth\">key_type_request_key_auth</a>", 
"<span class=\"ts\"/>    ) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* defend against the auth key being revoked */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#down_read\">down_read</a>(&amp;<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#key_validate\">key_validate</a>(<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>) == 0) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#rka\">rka</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>-><a class=\"id\" href=\"#payload\">payload</a>.<a class=\"id\" href=\"#data\">data</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#search_process_keyrings\">search_process_keyrings</a>(<a class=\"id\" href=\"#type\">type</a>, <a class=\"id\" href=\"#description\">description</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#match\">match</a>, <a class=\"id\" href=\"#rka\">rka</a>-><a class=\"id\" href=\"#cred\">cred</a>);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#up_read\">up_read</a>(&amp;<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#found\">found</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#up_read\">up_read</a>(&amp;<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* no key - decide on the error we're going to go for */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a> == <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>) || <a class=\"id\" href=\"#ret\">ret</a> == <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>);", 
"<span class=\"ts\"/>else if (<a class=\"id\" href=\"#err\">err</a> == <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#EACCES\">EACCES</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ret\">ret</a>;", 
"<span class=\"ts\"/>else", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<a class=\"id\" href=\"#found\">found</a>:", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"", 
"} <span class=\"comment\">/* end search_process_keyrings() */</span>", 
"", 
"<span class=\"comment\">/*****************************************************************************/</span>", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * see if the key we're looking at is the target key</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#lookup_user_key_possessed\">lookup_user_key_possessed</a>(const struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#key\">key</a>, const void *<a class=\"id\" href=\"#target\">target</a>)", 
"{", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#key\">key</a> == <a class=\"id\" href=\"#target\">target</a>;", 
"", 
"} <span class=\"comment\">/* end lookup_user_key_possessed() */</span>", 
"", 
"<span class=\"comment\">/*****************************************************************************/</span>", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * lookup a key given a key ID from userspace with a given permissions mask</span>", 
"<span class=\"comment\"> * - don't create special keyrings unless so requested</span>", 
"<span class=\"comment\"> * - partially constructed keys aren't found unless requested</span>", 
"<span class=\"comment\"> */</span>", 
"<a class=\"id\" href=\"#key_ref_t\">key_ref_t</a> <a class=\"id\" href=\"#lookup_user_key\">lookup_user_key</a>(<a class=\"id\" href=\"#key_serial_t\">key_serial_t</a> <a class=\"id\" href=\"#id\">id</a>, unsigned long <a class=\"id\" href=\"#lflags\">lflags</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#key_perm_t\">key_perm_t</a> <a class=\"id\" href=\"#perm\">perm</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#request_key_auth\">request_key_auth</a> *<a class=\"id\" href=\"#rka\">rka</a>;", 
"<span class=\"ts\"/>const struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#cred\">cred</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#key\">key</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref_t\">key_ref_t</a> <a class=\"id\" href=\"#key_ref\">key_ref</a>, <a class=\"id\" href=\"#skey_ref\">skey_ref</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<a class=\"id\" href=\"#try_again\">try_again</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#cred\">cred</a> = <a class=\"id\" href=\"#get_current_cred\">get_current_cred</a>();", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>);", 
"", 
"<span class=\"ts\"/>switch (<a class=\"id\" href=\"#id\">id</a>) {", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#KEY_SPEC_THREAD_KEYRING\">KEY_SPEC_THREAD_KEYRING</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (!(<a class=\"id\" href=\"#lflags\">lflags</a> &amp; <a class=\"id\" href=\"#KEY_LOOKUP_CREATE\">KEY_LOOKUP_CREATE</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_thread_keyring\">install_thread_keyring</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(<a class=\"id\" href=\"#ret\">ret</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#reget_creds\">reget_creds</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#usage\">usage</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#key\">key</a>, 1);", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#KEY_SPEC_PROCESS_KEYRING\">KEY_SPEC_PROCESS_KEYRING</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (!(<a class=\"id\" href=\"#lflags\">lflags</a> &amp; <a class=\"id\" href=\"#KEY_LOOKUP_CREATE\">KEY_LOOKUP_CREATE</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_process_keyring\">install_process_keyring</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(<a class=\"id\" href=\"#ret\">ret</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#reget_creds\">reget_creds</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#usage\">usage</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#key\">key</a>, 1);", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#KEY_SPEC_SESSION_KEYRING\">KEY_SPEC_SESSION_KEYRING</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* always install a session keyring upon access if one</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/> * doesn't exist yet */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_user_keyrings\">install_user_keyrings</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_session_keyring\">install_session_keyring</a>(", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#reget_creds\">reget_creds</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#rcu_read_lock\">rcu_read_lock</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#rcu_dereference\">rcu_dereference</a>(<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#usage\">usage</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#rcu_read_unlock\">rcu_read_unlock</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#key\">key</a>, 1);", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#KEY_SPEC_USER_KEYRING\">KEY_SPEC_USER_KEYRING</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_user_keyrings\">install_user_keyrings</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#uid_keyring\">uid_keyring</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#usage\">usage</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#key\">key</a>, 1);", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#KEY_SPEC_USER_SESSION_KEYRING\">KEY_SPEC_USER_SESSION_KEYRING</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_user_keyrings\">install_user_keyrings</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#user\">user</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#usage\">usage</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#key\">key</a>, 1);", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#KEY_SPEC_GROUP_KEYRING\">KEY_SPEC_GROUP_KEYRING</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* group keyrings are not yet supported */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#EINVAL\">EINVAL</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#KEY_SPEC_REQKEY_AUTH_KEY\">KEY_SPEC_REQKEY_AUTH_KEY</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#key\">key</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#usage\">usage</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#key\">key</a>, 1);", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#KEY_SPEC_REQUESTOR_KEYRING\">KEY_SPEC_REQUESTOR_KEYRING</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#down_read\">down_read</a>(&amp;<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>-><a class=\"id\" href=\"#flags\">flags</a> &amp; <a class=\"id\" href=\"#KEY_FLAG_REVOKED\">KEY_FLAG_REVOKED</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#EKEYREVOKED\">EKEYREVOKED</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#rka\">rka</a> = <a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>-><a class=\"id\" href=\"#payload\">payload</a>.<a class=\"id\" href=\"#data\">data</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#rka\">rka</a>-><a class=\"id\" href=\"#dest_keyring\">dest_keyring</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#usage\">usage</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#up_read\">up_read</a>(&amp;<a class=\"id\" href=\"#cred\">cred</a>-><a class=\"id\" href=\"#request_key_auth\">request_key_auth</a>-><a class=\"id\" href=\"#sem\">sem</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#key\">key</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#key\">key</a>, 1);", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"", 
"<span class=\"ts\"/>default:", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(-<a class=\"id\" href=\"#EINVAL\">EINVAL</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#id\">id</a> &lt; 1)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key\">key</a> = <a class=\"id\" href=\"#key_lookup\">key_lookup</a>(<a class=\"id\" href=\"#id\">id</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#key\">key</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_CAST\">ERR_CAST</a>(<a class=\"id\" href=\"#key\">key</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#make_key_ref\">make_key_ref</a>(<a class=\"id\" href=\"#key\">key</a>, 0);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* check to see if we possess the key */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#skey_ref\">skey_ref</a> = <a class=\"id\" href=\"#search_process_keyrings\">search_process_keyrings</a>(<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#type\">type</a>, <a class=\"id\" href=\"#key\">key</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>   <a class=\"id\" href=\"#lookup_user_key_possessed\">lookup_user_key_possessed</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>   <a class=\"id\" href=\"#cred\">cred</a>);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#skey_ref\">skey_ref</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_put\">key_put</a>(<a class=\"id\" href=\"#key\">key</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#skey_ref\">skey_ref</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* unlink does not use the nominated key in any way, so can skip all</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * the permission checks as it is only concerned with the keyring */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#lflags\">lflags</a> &amp; <a class=\"id\" href=\"#KEY_LOOKUP_FOR_UNLINK\">KEY_LOOKUP_FOR_UNLINK</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = 0;", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>if (!(<a class=\"id\" href=\"#lflags\">lflags</a> &amp; <a class=\"id\" href=\"#KEY_LOOKUP_PARTIAL\">KEY_LOOKUP_PARTIAL</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#wait_for_key_construction\">wait_for_key_construction</a>(<a class=\"id\" href=\"#key\">key</a>, <a class=\"id\" href=\"#true\">true</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>switch (<a class=\"id\" href=\"#ret\">ret</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/>case -<a class=\"id\" href=\"#ERESTARTSYS\">ERESTARTSYS</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#invalid_key\">invalid_key</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>default:", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#perm\">perm</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#invalid_key\">invalid_key</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>case 0:", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>} else if (<a class=\"id\" href=\"#perm\">perm</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#key_validate\">key_validate</a>(<a class=\"id\" href=\"#key\">key</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#invalid_key\">invalid_key</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = -<a class=\"id\" href=\"#EIO\">EIO</a>;", 
"<span class=\"ts\"/>if (!(<a class=\"id\" href=\"#lflags\">lflags</a> &amp; <a class=\"id\" href=\"#KEY_LOOKUP_PARTIAL\">KEY_LOOKUP_PARTIAL</a>) &&", 
"<span class=\"ts\"/>    !<a class=\"id\" href=\"#test_bit\">test_bit</a>(<a class=\"id\" href=\"#KEY_FLAG_INSTANTIATED\">KEY_FLAG_INSTANTIATED</a>, &amp;<a class=\"id\" href=\"#key\">key</a>-><a class=\"id\" href=\"#flags\">flags</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#invalid_key\">invalid_key</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* check the permissions */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#key_task_permission\">key_task_permission</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>, <a class=\"id\" href=\"#cred\">cred</a>, <a class=\"id\" href=\"#perm\">perm</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#invalid_key\">invalid_key</a>;", 
"", 
"<a class=\"id\" href=\"#error\">error</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#put_cred\">put_cred</a>(<a class=\"id\" href=\"#cred\">cred</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#key_ref\">key_ref</a>;", 
"", 
"<a class=\"id\" href=\"#invalid_key\">invalid_key</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref_put\">key_ref_put</a>(<a class=\"id\" href=\"#key_ref\">key_ref</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_ref\">key_ref</a> = <a class=\"id\" href=\"#ERR_PTR\">ERR_PTR</a>(<a class=\"id\" href=\"#ret\">ret</a>);", 
"<span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* if we attempted to install a keyring, then it may have caused new</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * creds to be installed */</span>", 
"<a class=\"id\" href=\"#reget_creds\">reget_creds</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#put_cred\">put_cred</a>(<a class=\"id\" href=\"#cred\">cred</a>);", 
"<span class=\"ts\"/>goto <a class=\"id\" href=\"#try_again\">try_again</a>;", 
"", 
"} <span class=\"comment\">/* end lookup_user_key() */</span>", 
"", 
"<span class=\"comment\">/*****************************************************************************/</span>", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * join the named keyring as the session keyring if possible, or attempt to</span>", 
"<span class=\"comment\"> * create a new one of that name if not</span>", 
"<span class=\"comment\"> * - if the name is NULL, an empty anonymous keyring is installed instead</span>", 
"<span class=\"comment\"> * - named session keyring joining is done with a semaphore held</span>", 
"<span class=\"comment\"> */</span>", 
"long <a class=\"id\" href=\"#join_session_keyring\">join_session_keyring</a>(const char *<a class=\"id\" href=\"#name\">name</a>)", 
"{", 
"<span class=\"ts\"/>const struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#old\">old</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#new\">new</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#key\">key</a> *<a class=\"id\" href=\"#keyring\">keyring</a>;", 
"<span class=\"ts\"/>long <a class=\"id\" href=\"#ret\">ret</a>, <a class=\"id\" href=\"#serial\">serial</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* only permit this if there's a single thread in the thread group -</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * this avoids us having to adjust the creds on all threads and risking</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * ENOMEM */</span>", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#current_is_single_threaded\">current_is_single_threaded</a>())", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#EMLINK\">EMLINK</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a> = <a class=\"id\" href=\"#prepare_creds\">prepare_creds</a>();", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#new\">new</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#ENOMEM\">ENOMEM</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#old\">old</a> = <a class=\"id\" href=\"#current_cred\">current_cred</a>();", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* if no name is provided, install an anonymous keyring */</span>", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#name\">name</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_session_keyring_to_cred\">install_session_keyring_to_cred</a>(<a class=\"id\" href=\"#new\">new</a>, <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error\">error</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#serial\">serial</a> = <a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#session_keyring\">session_keyring</a>-><a class=\"id\" href=\"#serial\">serial</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#commit_creds\">commit_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> == 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#serial\">serial</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#okay\">okay</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* allow the user to join or create a named keyring */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mutex_lock\">mutex_lock</a>(&amp;<a class=\"id\" href=\"#key_session_mutex\">key_session_mutex</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* look for an existing keyring of this name */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#keyring\">keyring</a> = <a class=\"id\" href=\"#find_keyring_by_name\">find_keyring_by_name</a>(<a class=\"id\" href=\"#name\">name</a>, <a class=\"id\" href=\"#false\">false</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>) == -<a class=\"id\" href=\"#ENOKEY\">ENOKEY</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* not found - try and create a new one */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#keyring\">keyring</a> = <a class=\"id\" href=\"#keyring_alloc\">keyring_alloc</a>(<a class=\"id\" href=\"#name\">name</a>, <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#uid\">uid</a>, <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#gid\">gid</a>, <a class=\"id\" href=\"#old\">old</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#KEY_ALLOC_IN_QUOTA\">KEY_ALLOC_IN_QUOTA</a>, <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error2\">error2</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>} else if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#keyring\">keyring</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error2\">error2</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* we've got a keyring - now to install it */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#install_session_keyring_to_cred\">install_session_keyring_to_cred</a>(<a class=\"id\" href=\"#new\">new</a>, <a class=\"id\" href=\"#keyring\">keyring</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> &lt; 0)", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#error2\">error2</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#commit_creds\">commit_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mutex_unlock\">mutex_unlock</a>(&amp;<a class=\"id\" href=\"#key_session_mutex\">key_session_mutex</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#keyring\">keyring</a>-><a class=\"id\" href=\"#serial\">serial</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#key_put\">key_put</a>(<a class=\"id\" href=\"#keyring\">keyring</a>);", 
"<a class=\"id\" href=\"#okay\">okay</a>:", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<a class=\"id\" href=\"#error2\">error2</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mutex_unlock\">mutex_unlock</a>(&amp;<a class=\"id\" href=\"#key_session_mutex\">key_session_mutex</a>);", 
"<a class=\"id\" href=\"#error\">error</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#abort_creds\">abort_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Replace a process's session keyring when that process resumes userspace on</span>", 
"<span class=\"comment\"> * behalf of one of its children</span>", 
"<span class=\"comment\"> */</span>", 
"void <a class=\"id\" href=\"#key_replace_session_keyring\">key_replace_session_keyring</a>(void)", 
"{", 
"<span class=\"ts\"/>const struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#old\">old</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#cred\">cred</a> *<a class=\"id\" href=\"#new\">new</a>;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#current\">current</a>-><a class=\"id\" href=\"#replacement_session_keyring\">replacement_session_keyring</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#write_lock_irq\">write_lock_irq</a>(&amp;<a class=\"id\" href=\"#tasklist_lock\">tasklist_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a> = <a class=\"id\" href=\"#current\">current</a>-><a class=\"id\" href=\"#replacement_session_keyring\">replacement_session_keyring</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#current\">current</a>-><a class=\"id\" href=\"#replacement_session_keyring\">replacement_session_keyring</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#write_unlock_irq\">write_unlock_irq</a>(&amp;<a class=\"id\" href=\"#tasklist_lock\">tasklist_lock</a>);", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#new\">new</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#old\">old</a> = <a class=\"id\" href=\"#current_cred\">current_cred</a>();", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>->  <a class=\"id\" href=\"#uid\">uid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>->  <a class=\"id\" href=\"#uid\">uid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-> <a class=\"id\" href=\"#euid\">euid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-> <a class=\"id\" href=\"#euid\">euid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-> <a class=\"id\" href=\"#suid\">suid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-> <a class=\"id\" href=\"#suid\">suid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#fsuid\">fsuid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#fsuid\">fsuid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>->  <a class=\"id\" href=\"#gid\">gid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>->  <a class=\"id\" href=\"#gid\">gid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-> <a class=\"id\" href=\"#egid\">egid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-> <a class=\"id\" href=\"#egid\">egid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-> <a class=\"id\" href=\"#sgid\">sgid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-> <a class=\"id\" href=\"#sgid\">sgid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#fsgid\">fsgid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#fsgid\">fsgid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#user\">user</a><span class=\"ts\"/>= <a class=\"id\" href=\"#get_uid\">get_uid</a>(<a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#user\">user</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#group_info\">group_info</a><span class=\"ts\"/>= <a class=\"id\" href=\"#get_group_info\">get_group_info</a>(<a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#group_info\">group_info</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#securebits\">securebits</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#securebits\">securebits</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#cap_inheritable\">cap_inheritable</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#cap_inheritable\">cap_inheritable</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#cap_permitted\">cap_permitted</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#cap_permitted\">cap_permitted</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#cap_effective\">cap_effective</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#cap_effective\">cap_effective</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#cap_bset\">cap_bset</a><span class=\"ts\"/><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#cap_bset\">cap_bset</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#jit_keyring\">jit_keyring</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#jit_keyring\">jit_keyring</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a><span class=\"ts\"/>= <a class=\"id\" href=\"#key_get\">key_get</a>(<a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#thread_keyring\">thread_keyring</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#tgid\">tgid</a><span class=\"ts\"/>= <a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#tgid\">tgid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new\">new</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a> = <a class=\"id\" href=\"#key_get\">key_get</a>(<a class=\"id\" href=\"#old\">old</a>-><a class=\"id\" href=\"#tgcred\">tgcred</a>-><a class=\"id\" href=\"#process_keyring\">process_keyring</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#security_transfer_creds\">security_transfer_creds</a>(<a class=\"id\" href=\"#new\">new</a>, <a class=\"id\" href=\"#old\">old</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#commit_creds\">commit_creds</a>(<a class=\"id\" href=\"#new\">new</a>);", 
"}", 
];
xr_frag_insert('l/bd/7769fa03066f2682ca594d59617983e84059aa.xr', __xr_tmp);
