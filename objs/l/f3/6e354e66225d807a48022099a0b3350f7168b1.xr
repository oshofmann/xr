var __xr_tmp = [
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * linux/fs/jbd/journal.c</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Written by Stephen C. Tweedie &lt;sct@redhat.com&gt;, 1998</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Copyright 1998 Red Hat corp --- All Rights Reserved</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * This file is part of the Linux kernel and is made available under</span>", 
"<span class=\"comment\"> * the terms of the GNU General Public License, version 2, or at your</span>", 
"<span class=\"comment\"> * option, any later version, incorporated herein by reference.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Generic filesystem journal-writing code; part of the ext2fs</span>", 
"<span class=\"comment\"> * journaling system.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * This file manages journals: areas of disk reserved for logging</span>", 
"<span class=\"comment\"> * transactional updates.  This includes the kernel journaling thread</span>", 
"<span class=\"comment\"> * which is responsible for scheduling updates to the log.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * We do not actually manage the physical storage of the journal in this</span>", 
"<span class=\"comment\"> * file: that is left to a per-journal policy function, which allows us</span>", 
"<span class=\"comment\"> * to store the journal within a filesystem-specified area for ext2</span>", 
"<span class=\"comment\"> * journaling (ext2 can use a reserved inode for storing the log).</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#module\">module</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#time\">time</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#fs\">fs</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#jbd\">jbd</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#errno\">errno</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#slab\">slab</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#init\">init</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#mm\">mm</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#freezer\">freezer</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#pagemap\">pagemap</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#kthread\">kthread</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#poison\">poison</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#proc_fs\">proc_fs</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#linux\">linux</a>/<a class=\"id\" href=\"#debugfs\">debugfs</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#asm\">asm</a>/<a class=\"id\" href=\"#uaccess\">uaccess</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"#<a class=\"id\" href=\"#include\">include</a> &lt;<a class=\"id\" href=\"#asm\">asm</a>/<a class=\"id\" href=\"#page\">page</a>.<a class=\"id\" href=\"#h\">h</a>&gt;", 
"", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_start\">journal_start</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_restart\">journal_restart</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_extend\">journal_extend</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_stop\">journal_stop</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_lock_updates\">journal_lock_updates</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_unlock_updates\">journal_unlock_updates</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_get_write_access\">journal_get_write_access</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_get_create_access\">journal_get_create_access</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_get_undo_access\">journal_get_undo_access</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_dirty_data\">journal_dirty_data</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_dirty_metadata\">journal_dirty_metadata</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_release_buffer\">journal_release_buffer</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_forget\">journal_forget</a>);", 
"#if 0", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_sync_buffer\">journal_sync_buffer</a>);", 
"#<a class=\"id\" href=\"#endif\">endif</a>", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_flush\">journal_flush</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_revoke\">journal_revoke</a>);", 
"", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_init_dev\">journal_init_dev</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_init_inode\">journal_init_inode</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_update_format\">journal_update_format</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_check_used_features\">journal_check_used_features</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_check_available_features\">journal_check_available_features</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_set_features\">journal_set_features</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_create\">journal_create</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_load\">journal_load</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_destroy\">journal_destroy</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_abort\">journal_abort</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_errno\">journal_errno</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_ack_err\">journal_ack_err</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_clear_err\">journal_clear_err</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#log_wait_commit\">log_wait_commit</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#log_start_commit\">log_start_commit</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_start_commit\">journal_start_commit</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_force_commit_nested\">journal_force_commit_nested</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_wipe\">journal_wipe</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_blocks_per_page\">journal_blocks_per_page</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_invalidatepage\">journal_invalidatepage</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_try_to_free_buffers\">journal_try_to_free_buffers</a>);", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_force_commit\">journal_force_commit</a>);", 
"", 
"static int <a class=\"id\" href=\"#journal_convert_superblock_v1\">journal_convert_superblock_v1</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *, <a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *);", 
"static void <a class=\"id\" href=\"#__journal_abort_soft\">__journal_abort_soft</a> (<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, int <a class=\"id\" href=\"#errno\">errno</a>);", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Helper function used to manage commit timeouts</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"static void <a class=\"id\" href=\"#commit_timeout\">commit_timeout</a>(unsigned long <a class=\"id\" href=\"#__data\">__data</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#task_struct\">task_struct</a> * <a class=\"id\" href=\"#p\">p</a> = (struct <a class=\"id\" href=\"#task_struct\">task_struct</a> *) <a class=\"id\" href=\"#__data\">__data</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#wake_up_process\">wake_up_process</a>(<a class=\"id\" href=\"#p\">p</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * kjournald: The main thread function used to manage a logging device</span>", 
"<span class=\"comment\"> * journal.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * This kernel thread is responsible for two things:</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * 1) COMMIT:  Every so often we need to commit the current state of the</span>", 
"<span class=\"comment\"> *    filesystem to disk.  The journal thread is responsible for writing</span>", 
"<span class=\"comment\"> *    all of the metadata buffers to disk.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * 2) CHECKPOINT: We cannot reuse a used section of the log file until all</span>", 
"<span class=\"comment\"> *    of the data in that part of the log has been rewritten elsewhere on</span>", 
"<span class=\"comment\"> *    the disk.  Flushing these old buffers to reclaim space in the log is</span>", 
"<span class=\"comment\"> *    known as checkpointing, and this thread is responsible for that job.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"static int <a class=\"id\" href=\"#kjournald\">kjournald</a>(void *<a class=\"id\" href=\"#arg\">arg</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a> = <a class=\"id\" href=\"#arg\">arg</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#transaction_t\">transaction_t</a> *<a class=\"id\" href=\"#transaction\">transaction</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * Set up an interval timer which can be used to trigger a commit wakeup</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * after the commit interval expires</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#setup_timer\">setup_timer</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_timer\">j_commit_timer</a>, <a class=\"id\" href=\"#commit_timeout\">commit_timeout</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>(unsigned long)<a class=\"id\" href=\"#current\">current</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Record that the journal thread is running */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_task\">j_task</a> = <a class=\"id\" href=\"#current\">current</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#wake_up\">wake_up</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_done_commit\">j_wait_done_commit</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_INFO\">KERN_INFO</a> \"kjournald starting.  Commit interval %ld seconds\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_interval\">j_commit_interval</a> / <a class=\"id\" href=\"#HZ\">HZ</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * And now, wait forever for commit wakeup events.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"", 
"<a class=\"id\" href=\"#loop\">loop</a>:", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &amp; <a class=\"id\" href=\"#JFS_UNMOUNT\">JFS_UNMOUNT</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#end_loop\">end_loop</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"commit_sequence=%d, commit_request=%d\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a>);", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a> != <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"OK, requests differ\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#del_timer_sync\">del_timer_sync</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_timer\">j_commit_timer</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_commit_transaction\">journal_commit_transaction</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#loop\">loop</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#wake_up\">wake_up</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_done_commit\">j_wait_done_commit</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#freezing\">freezing</a>(<a class=\"id\" href=\"#current\">current</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * The simpler the better. Flushing journal isn't a</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * good idea, because that depends on threads that may</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * be already stopped.</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"Now suspending kjournald\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#refrigerator\">refrigerator</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * We assume on resume that commits are already there,</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * so we don't sleep</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#DEFINE_WAIT\">DEFINE_WAIT</a>(<a class=\"id\" href=\"#wait\">wait</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>int <a class=\"id\" href=\"#should_sleep\">should_sleep</a> = 1;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#prepare_to_wait\">prepare_to_wait</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_commit\">j_wait_commit</a>, &amp;<a class=\"id\" href=\"#wait\">wait</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#TASK_INTERRUPTIBLE\">TASK_INTERRUPTIBLE</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a> != <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#should_sleep\">should_sleep</a> = 0;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#transaction\">transaction</a> && <a class=\"id\" href=\"#time_after_eq\">time_after_eq</a>(<a class=\"id\" href=\"#jiffies\">jiffies</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_expires\">t_expires</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#should_sleep\">should_sleep</a> = 0;", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &amp; <a class=\"id\" href=\"#JFS_UNMOUNT\">JFS_UNMOUNT</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#should_sleep\">should_sleep</a> = 0;", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#should_sleep\">should_sleep</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#schedule\">schedule</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#finish_wait\">finish_wait</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_commit\">j_wait_commit</a>, &amp;<a class=\"id\" href=\"#wait\">wait</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"kjournald wakes\\n\");", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * Were we woken up by a commit wakeup event?</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>;", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#transaction\">transaction</a> && <a class=\"id\" href=\"#time_after_eq\">time_after_eq</a>(<a class=\"id\" href=\"#jiffies\">jiffies</a>, <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_expires\">t_expires</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a> = <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"woke because of timeout\\n\");", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>goto <a class=\"id\" href=\"#loop\">loop</a>;", 
"", 
"<a class=\"id\" href=\"#end_loop\">end_loop</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#del_timer_sync\">del_timer_sync</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_timer\">j_commit_timer</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_task\">j_task</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#wake_up\">wake_up</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_done_commit\">j_wait_done_commit</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"Journal thread exiting.\\n\");", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"static int <a class=\"id\" href=\"#journal_start_thread\">journal_start_thread</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#task_struct\">task_struct</a> *<a class=\"id\" href=\"#t\">t</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#t\">t</a> = <a class=\"id\" href=\"#kthread_run\">kthread_run</a>(<a class=\"id\" href=\"#kjournald\">kjournald</a>, <a class=\"id\" href=\"#journal\">journal</a>, \"kjournald\");", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#IS_ERR\">IS_ERR</a>(<a class=\"id\" href=\"#t\">t</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#PTR_ERR\">PTR_ERR</a>(<a class=\"id\" href=\"#t\">t</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#wait_event\">wait_event</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_done_commit\">j_wait_done_commit</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_task\">j_task</a> != <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"static void <a class=\"id\" href=\"#journal_kill_thread\">journal_kill_thread</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> |= <a class=\"id\" href=\"#JFS_UNMOUNT\">JFS_UNMOUNT</a>;", 
"", 
"<span class=\"ts\"/>while (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_task\">j_task</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#wake_up\">wake_up</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_commit\">j_wait_commit</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#wait_event\">wait_event</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_done_commit\">j_wait_done_commit</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_task\">j_task</a> == <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * journal_write_metadata_buffer: write a metadata buffer to the journal.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Writes a metadata buffer to a given disk block.  The actual IO is not</span>", 
"<span class=\"comment\"> * performed but a new buffer_head is constructed which labels the data</span>", 
"<span class=\"comment\"> * to be written with the correct destination disk block.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Any magic-number escaping which needs to be done will cause a</span>", 
"<span class=\"comment\"> * copy-out here.  If the buffer happens to start with the</span>", 
"<span class=\"comment\"> * JFS_MAGIC_NUMBER, then we can't write it to the log directly: the</span>", 
"<span class=\"comment\"> * magic number is only written to the log for descripter blocks.  In</span>", 
"<span class=\"comment\"> * this case, we copy the data and replace the first word with 0, and we</span>", 
"<span class=\"comment\"> * return a result code which indicates that this buffer needs to be</span>", 
"<span class=\"comment\"> * marked as an escaped buffer in the corresponding log descriptor</span>", 
"<span class=\"comment\"> * block.  The missing word can then be restored when the block is read</span>", 
"<span class=\"comment\"> * during recovery.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * If the source buffer has already been modified by a new transaction</span>", 
"<span class=\"comment\"> * since we took the last commit snapshot, we use the frozen copy of</span>", 
"<span class=\"comment\"> * that data for IO.  If we end up using the existing buffer_head's data</span>", 
"<span class=\"comment\"> * for the write, then we *have* to lock the buffer to prevent anyone</span>", 
"<span class=\"comment\"> * else from using and possibly modifying it while the IO is in</span>", 
"<span class=\"comment\"> * progress.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * The function returns a pointer to the buffer_heads to be used for IO.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * We assume that the journal has already been locked in this function.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Return value:</span>", 
"<span class=\"comment\"> *  &lt;0: Error</span>", 
"<span class=\"comment\"> * &gt;=0: Finished OK</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * On success:</span>", 
"<span class=\"comment\"> * Bit 0 set == escape performed on the data</span>", 
"<span class=\"comment\"> * Bit 1 set == buffer copy-out performed (kfree the data after IO)</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"int <a class=\"id\" href=\"#journal_write_metadata_buffer\">journal_write_metadata_buffer</a>(<a class=\"id\" href=\"#transaction_t\">transaction_t</a> *<a class=\"id\" href=\"#transaction\">transaction</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  struct <a class=\"id\" href=\"#journal_head\">journal_head</a>  *<a class=\"id\" href=\"#jh_in\">jh_in</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  struct <a class=\"id\" href=\"#journal_head\">journal_head</a> **<a class=\"id\" href=\"#jh_out\">jh_out</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  unsigned int <a class=\"id\" href=\"#blocknr\">blocknr</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#need_copy_out\">need_copy_out</a> = 0;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#done_copy_out\">done_copy_out</a> = 0;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#do_escape\">do_escape</a> = 0;", 
"<span class=\"ts\"/>char *<a class=\"id\" href=\"#mapped_data\">mapped_data</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#new_bh\">new_bh</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#new_jh\">new_jh</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#page\">page</a> *<a class=\"id\" href=\"#new_page\">new_page</a>;", 
"<span class=\"ts\"/>unsigned int <a class=\"id\" href=\"#new_offset\">new_offset</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh_in\">bh_in</a> = <a class=\"id\" href=\"#jh2bh\">jh2bh</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a> = <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_journal\">t_journal</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * The buffer really shouldn't be locked: only the current committing</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * transaction is allowed to write it, so nobody else is allowed</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * to do any IO.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> *</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * akpm: except if we're journalling data, and write() output is</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * also part of a shared mapping, and another thread has</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * decided to launch a writepage() against this buffer.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT_BH\">J_ASSERT_BH</a>(<a class=\"id\" href=\"#bh_in\">bh_in</a>, <a class=\"id\" href=\"#buffer_jbddirty\">buffer_jbddirty</a>(<a class=\"id\" href=\"#bh_in\">bh_in</a>));", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new_bh\">new_bh</a> = <a class=\"id\" href=\"#alloc_buffer_head\">alloc_buffer_head</a>(<a class=\"id\" href=\"#GFP_NOFS\">GFP_NOFS</a>|<a class=\"id\" href=\"#__GFP_NOFAIL\">__GFP_NOFAIL</a>);", 
"<span class=\"ts\"/><span class=\"comment\">/* keep subsequent assertions sane */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new_bh\">new_bh</a>-><a class=\"id\" href=\"#b_state\">b_state</a> = 0;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#init_buffer\">init_buffer</a>(<a class=\"id\" href=\"#new_bh\">new_bh</a>, <a class=\"id\" href=\"#NULL\">NULL</a>, <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#atomic_set\">atomic_set</a>(&amp;<a class=\"id\" href=\"#new_bh\">new_bh</a>-><a class=\"id\" href=\"#b_count\">b_count</a>, 1);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new_jh\">new_jh</a> = <a class=\"id\" href=\"#journal_add_journal_head\">journal_add_journal_head</a>(<a class=\"id\" href=\"#new_bh\">new_bh</a>);<span class=\"ts\"/><span class=\"comment\">/* This sleeps */</span>", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * If a new transaction has already done a buffer copy-out, then</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * we use that version of the data for the commit.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_lock_bh_state\">jbd_lock_bh_state</a>(<a class=\"id\" href=\"#bh_in\">bh_in</a>);", 
"<a class=\"id\" href=\"#repeat\">repeat</a>:", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#jh_in\">jh_in</a>-><a class=\"id\" href=\"#b_frozen_data\">b_frozen_data</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#done_copy_out\">done_copy_out</a> = 1;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new_page\">new_page</a> = <a class=\"id\" href=\"#virt_to_page\">virt_to_page</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>-><a class=\"id\" href=\"#b_frozen_data\">b_frozen_data</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new_offset\">new_offset</a> = <a class=\"id\" href=\"#offset_in_page\">offset_in_page</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>-><a class=\"id\" href=\"#b_frozen_data\">b_frozen_data</a>);", 
"<span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new_page\">new_page</a> = <a class=\"id\" href=\"#jh2bh\">jh2bh</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>)-><a class=\"id\" href=\"#b_page\">b_page</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new_offset\">new_offset</a> = <a class=\"id\" href=\"#offset_in_page\">offset_in_page</a>(<a class=\"id\" href=\"#jh2bh\">jh2bh</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>)-><a class=\"id\" href=\"#b_data\">b_data</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mapped_data\">mapped_data</a> = <a class=\"id\" href=\"#kmap_atomic\">kmap_atomic</a>(<a class=\"id\" href=\"#new_page\">new_page</a>, <a class=\"id\" href=\"#KM_USER0\">KM_USER0</a>);", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * Check for escaping</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/>if (*((<a class=\"id\" href=\"#__be32\">__be32</a> *)(<a class=\"id\" href=\"#mapped_data\">mapped_data</a> + <a class=\"id\" href=\"#new_offset\">new_offset</a>)) ==", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#JFS_MAGIC_NUMBER\">JFS_MAGIC_NUMBER</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#need_copy_out\">need_copy_out</a> = 1;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#do_escape\">do_escape</a> = 1;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kunmap_atomic\">kunmap_atomic</a>(<a class=\"id\" href=\"#mapped_data\">mapped_data</a>, <a class=\"id\" href=\"#KM_USER0\">KM_USER0</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * Do we need to do a data copy?</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#need_copy_out\">need_copy_out</a> && !<a class=\"id\" href=\"#done_copy_out\">done_copy_out</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/>char *<a class=\"id\" href=\"#tmp\">tmp</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_unlock_bh_state\">jbd_unlock_bh_state</a>(<a class=\"id\" href=\"#bh_in\">bh_in</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#tmp\">tmp</a> = <a class=\"id\" href=\"#jbd_alloc\">jbd_alloc</a>(<a class=\"id\" href=\"#bh_in\">bh_in</a>-><a class=\"id\" href=\"#b_size\">b_size</a>, <a class=\"id\" href=\"#GFP_NOFS\">GFP_NOFS</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_lock_bh_state\">jbd_lock_bh_state</a>(<a class=\"id\" href=\"#bh_in\">bh_in</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#jh_in\">jh_in</a>-><a class=\"id\" href=\"#b_frozen_data\">b_frozen_data</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_free\">jbd_free</a>(<a class=\"id\" href=\"#tmp\">tmp</a>, <a class=\"id\" href=\"#bh_in\">bh_in</a>-><a class=\"id\" href=\"#b_size\">b_size</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#repeat\">repeat</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh_in\">jh_in</a>-><a class=\"id\" href=\"#b_frozen_data\">b_frozen_data</a> = <a class=\"id\" href=\"#tmp\">tmp</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#mapped_data\">mapped_data</a> = <a class=\"id\" href=\"#kmap_atomic\">kmap_atomic</a>(<a class=\"id\" href=\"#new_page\">new_page</a>, <a class=\"id\" href=\"#KM_USER0\">KM_USER0</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#memcpy\">memcpy</a>(<a class=\"id\" href=\"#tmp\">tmp</a>, <a class=\"id\" href=\"#mapped_data\">mapped_data</a> + <a class=\"id\" href=\"#new_offset\">new_offset</a>, <a class=\"id\" href=\"#jh2bh\">jh2bh</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>)-><a class=\"id\" href=\"#b_size\">b_size</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#kunmap_atomic\">kunmap_atomic</a>(<a class=\"id\" href=\"#mapped_data\">mapped_data</a>, <a class=\"id\" href=\"#KM_USER0\">KM_USER0</a>);", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new_page\">new_page</a> = <a class=\"id\" href=\"#virt_to_page\">virt_to_page</a>(<a class=\"id\" href=\"#tmp\">tmp</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new_offset\">new_offset</a> = <a class=\"id\" href=\"#offset_in_page\">offset_in_page</a>(<a class=\"id\" href=\"#tmp\">tmp</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#done_copy_out\">done_copy_out</a> = 1;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * Did we need to do an escaping?  Now we've done all the</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * copying, we can finally do so.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#do_escape\">do_escape</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#mapped_data\">mapped_data</a> = <a class=\"id\" href=\"#kmap_atomic\">kmap_atomic</a>(<a class=\"id\" href=\"#new_page\">new_page</a>, <a class=\"id\" href=\"#KM_USER0\">KM_USER0</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>*((unsigned int *)(<a class=\"id\" href=\"#mapped_data\">mapped_data</a> + <a class=\"id\" href=\"#new_offset\">new_offset</a>)) = 0;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#kunmap_atomic\">kunmap_atomic</a>(<a class=\"id\" href=\"#mapped_data\">mapped_data</a>, <a class=\"id\" href=\"#KM_USER0\">KM_USER0</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#set_bh_page\">set_bh_page</a>(<a class=\"id\" href=\"#new_bh\">new_bh</a>, <a class=\"id\" href=\"#new_page\">new_page</a>, <a class=\"id\" href=\"#new_offset\">new_offset</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new_jh\">new_jh</a>-><a class=\"id\" href=\"#b_transaction\">b_transaction</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new_bh\">new_bh</a>-><a class=\"id\" href=\"#b_size\">b_size</a> = <a class=\"id\" href=\"#jh2bh\">jh2bh</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>)-><a class=\"id\" href=\"#b_size\">b_size</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new_bh\">new_bh</a>-><a class=\"id\" href=\"#b_bdev\">b_bdev</a> = <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_journal\">t_journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#new_bh\">new_bh</a>-><a class=\"id\" href=\"#b_blocknr\">b_blocknr</a> = <a class=\"id\" href=\"#blocknr\">blocknr</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#set_buffer_mapped\">set_buffer_mapped</a>(<a class=\"id\" href=\"#new_bh\">new_bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#set_buffer_dirty\">set_buffer_dirty</a>(<a class=\"id\" href=\"#new_bh\">new_bh</a>);", 
"", 
"<span class=\"ts\"/>*<a class=\"id\" href=\"#jh_out\">jh_out</a> = <a class=\"id\" href=\"#new_jh\">new_jh</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * The to-be-written buffer needs to get moved to the io queue,</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * and the original buffer whose contents we are shadowing or</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * copying is moved to the transaction's shadow queue.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#JBUFFER_TRACE\">JBUFFER_TRACE</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>, \"file as BJ_Shadow\");", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#__journal_file_buffer\">__journal_file_buffer</a>(<a class=\"id\" href=\"#jh_in\">jh_in</a>, <a class=\"id\" href=\"#transaction\">transaction</a>, <a class=\"id\" href=\"#BJ_Shadow\">BJ_Shadow</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_unlock_bh_state\">jbd_unlock_bh_state</a>(<a class=\"id\" href=\"#bh_in\">bh_in</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#JBUFFER_TRACE\">JBUFFER_TRACE</a>(<a class=\"id\" href=\"#new_jh\">new_jh</a>, \"file as BJ_IO\");", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_file_buffer\">journal_file_buffer</a>(<a class=\"id\" href=\"#new_jh\">new_jh</a>, <a class=\"id\" href=\"#transaction\">transaction</a>, <a class=\"id\" href=\"#BJ_IO\">BJ_IO</a>);", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#do_escape\">do_escape</a> | (<a class=\"id\" href=\"#done_copy_out\">done_copy_out</a> << 1);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Allocation code for the journal file.  Manage the space left in the</span>", 
"<span class=\"comment\"> * journal, so that we can begin checkpointing when appropriate.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * __log_space_left: Return the number of free blocks left in the journal.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Called with the journal already locked.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Called under j_state_lock</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"int <a class=\"id\" href=\"#__log_space_left\">__log_space_left</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#left\">left</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_free\">j_free</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#assert_spin_locked\">assert_spin_locked</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * Be pessimistic here about the number of those free blocks which</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * might be required for log descriptor control blocks.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"", 
"#<a class=\"id\" href=\"#define\">define</a> <a class=\"id\" href=\"#MIN_LOG_RESERVED_BLOCKS\">MIN_LOG_RESERVED_BLOCKS</a> 32 <span class=\"comment\">/* Allow for rounding errors */</span>", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#left\">left</a> -= <a class=\"id\" href=\"#MIN_LOG_RESERVED_BLOCKS\">MIN_LOG_RESERVED_BLOCKS</a>;", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#left\">left</a> <= 0)", 
"<span class=\"ts\"/><span class=\"ts\"/>return 0;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#left\">left</a> -= (<a class=\"id\" href=\"#left\">left</a> >> 3);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#left\">left</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Called under j_state_lock.  Returns true if a transaction commit was started.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#__log_start_commit\">__log_start_commit</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid_t\">tid_t</a> <a class=\"id\" href=\"#target\">target</a>)", 
"{", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * Are we already doing a recent enough commit?</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#tid_geq\">tid_geq</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a>, <a class=\"id\" href=\"#target\">target</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * We want a new commit: OK, mark the request and wakup the</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * commit thread.  We do _not_ do the commit ourselves.</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> */</span>", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a> = <a class=\"id\" href=\"#target\">target</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"JBD: requesting commit %d/%d\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#wake_up\">wake_up</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_commit\">j_wait_commit</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>return 1;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"int <a class=\"id\" href=\"#log_start_commit\">log_start_commit</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid_t\">tid_t</a> <a class=\"id\" href=\"#tid\">tid</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#__log_start_commit\">__log_start_commit</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid\">tid</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Force and wait upon a commit if the calling process is not within</span>", 
"<span class=\"comment\"> * transaction.  This is used for forcing out undo-protected data which contains</span>", 
"<span class=\"comment\"> * bitmaps, when the fs is running out of space.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * We can only force the running transaction if we don't have an active handle;</span>", 
"<span class=\"comment\"> * otherwise, we will deadlock.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Returns true if a transaction was started.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_force_commit_nested\">journal_force_commit_nested</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#transaction_t\">transaction_t</a> *<a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#tid_t\">tid_t</a> <a class=\"id\" href=\"#tid\">tid</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a> && !<a class=\"id\" href=\"#current\">current</a>-><a class=\"id\" href=\"#journal_info\">journal_info</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__log_start_commit\">__log_start_commit</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a>);", 
"<span class=\"ts\"/>} else if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a>;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#transaction\">transaction</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>return 0;<span class=\"ts\"/><span class=\"comment\">/* Nothing to retry */</span>", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#tid\">tid</a> = <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#log_wait_commit\">log_wait_commit</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid\">tid</a>);", 
"<span class=\"ts\"/>return 1;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Start a commit of the current running transaction (if any).  Returns true</span>", 
"<span class=\"comment\"> * if a transaction is going to be committed (or is currently already</span>", 
"<span class=\"comment\"> * committing), and fills its tid in at *ptid</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_start_commit\">journal_start_commit</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid_t\">tid_t</a> *<a class=\"id\" href=\"#ptid\">ptid</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a> = 0;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#tid_t\">tid_t</a> <a class=\"id\" href=\"#tid\">tid</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__log_start_commit\">__log_start_commit</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid\">tid</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* There's a running transaction and we've just made sure</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * it's commit has been scheduled. */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ptid\">ptid</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>*<a class=\"id\" href=\"#ptid\">ptid</a> = <a class=\"id\" href=\"#tid\">tid</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = 1;", 
"<span class=\"ts\"/>} else if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * If ext3_write_super() recently started a commit, then we</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * have to wait for completion of that transaction</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ptid\">ptid</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>*<a class=\"id\" href=\"#ptid\">ptid</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = 1;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Wait for a specified commit to complete.</span>", 
"<span class=\"comment\"> * The caller may not hold the journal lock.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#log_wait_commit\">log_wait_commit</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid_t\">tid_t</a> <a class=\"id\" href=\"#tid\">tid</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a> = 0;", 
"", 
"#<a class=\"id\" href=\"#ifdef\">ifdef</a> <a class=\"id\" href=\"#CONFIG_JBD_DEBUG\">CONFIG_JBD_DEBUG</a>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#tid_geq\">tid_geq</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a>, <a class=\"id\" href=\"#tid\">tid</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_EMERG\">KERN_EMERG</a>", 
"<span class=\"ts\"/><span class=\"ts\"/>       \"%s: error: j_commit_request=%d, tid=%d\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>       <a class=\"id\" href=\"#__func__\">__func__</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a>, <a class=\"id\" href=\"#tid\">tid</a>);", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"#<a class=\"id\" href=\"#endif\">endif</a>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>while (<a class=\"id\" href=\"#tid_gt\">tid_gt</a>(<a class=\"id\" href=\"#tid\">tid</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"JBD: want %d, j_commit_sequence=%d\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#tid\">tid</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#wake_up\">wake_up</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_commit\">j_wait_commit</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#wait_event\">wait_event</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_done_commit\">j_wait_done_commit</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>!<a class=\"id\" href=\"#tid_gt\">tid_gt</a>(<a class=\"id\" href=\"#tid\">tid</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a>));", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#unlikely\">unlikely</a>(<a class=\"id\" href=\"#is_journal_aborted\">is_journal_aborted</a>(<a class=\"id\" href=\"#journal\">journal</a>))) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_EMERG\">KERN_EMERG</a> \"journal commit I/O error\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = -<a class=\"id\" href=\"#EIO\">EIO</a>;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Return 1 if a given transaction has not yet sent barrier request</span>", 
"<span class=\"comment\"> * connected with a transaction commit. If 0 is returned, transaction</span>", 
"<span class=\"comment\"> * may or may not have sent the barrier. Used to avoid sending barrier</span>", 
"<span class=\"comment\"> * twice in common cases.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_trans_will_send_data_barrier\">journal_trans_will_send_data_barrier</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid_t\">tid_t</a> <a class=\"id\" href=\"#tid\">tid</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a> = 0;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#transaction_t\">transaction_t</a> *<a class=\"id\" href=\"#commit_trans\">commit_trans</a>;", 
"", 
"<span class=\"ts\"/>if (!(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &amp; <a class=\"id\" href=\"#JFS_BARRIER\">JFS_BARRIER</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>return 0;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"comment\">/* Transaction already committed? */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#tid_geq\">tid_geq</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a>, <a class=\"id\" href=\"#tid\">tid</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out\">out</a>;", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * Transaction is being committed and we already proceeded to</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * writing commit record?</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#commit_trans\">commit_trans</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a>;", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#commit_trans\">commit_trans</a> && <a class=\"id\" href=\"#commit_trans\">commit_trans</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a> == <a class=\"id\" href=\"#tid\">tid</a> &&", 
"<span class=\"ts\"/>    <a class=\"id\" href=\"#commit_trans\">commit_trans</a>-><a class=\"id\" href=\"#t_state\">t_state</a> >= <a class=\"id\" href=\"#T_COMMIT_RECORD\">T_COMMIT_RECORD</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out\">out</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = 1;", 
"<a class=\"id\" href=\"#out\">out</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_trans_will_send_data_barrier\">journal_trans_will_send_data_barrier</a>);", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Log buffer allocation routines:</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"int <a class=\"id\" href=\"#journal_next_log_block\">journal_next_log_block</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, unsigned int *<a class=\"id\" href=\"#retp\">retp</a>)", 
"{", 
"<span class=\"ts\"/>unsigned int <a class=\"id\" href=\"#blocknr\">blocknr</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_free\">j_free</a> &gt; 1);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#blocknr\">blocknr</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_head\">j_head</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_head\">j_head</a>++;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_free\">j_free</a>--;", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_head\">j_head</a> == <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_last\">j_last</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_head\">j_head</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_first\">j_first</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#journal_bmap\">journal_bmap</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#blocknr\">blocknr</a>, <a class=\"id\" href=\"#retp\">retp</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Conversion of logical to physical block numbers for the journal</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * On external journals the journal blocks are identity-mapped, so</span>", 
"<span class=\"comment\"> * this is a no-op.  If needed, we can use j_blk_offset - everything is</span>", 
"<span class=\"comment\"> * ready.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_bmap\">journal_bmap</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, unsigned int <a class=\"id\" href=\"#blocknr\">blocknr</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/> unsigned int *<a class=\"id\" href=\"#retp\">retp</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a> = 0;", 
"<span class=\"ts\"/>unsigned int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_inode\">j_inode</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#bmap\">bmap</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_inode\">j_inode</a>, <a class=\"id\" href=\"#blocknr\">blocknr</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>*<a class=\"id\" href=\"#retp\">retp</a> = <a class=\"id\" href=\"#ret\">ret</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>else {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>char <a class=\"id\" href=\"#b\">b</a>[<a class=\"id\" href=\"#BDEVNAME_SIZE\">BDEVNAME_SIZE</a>];", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_ALERT\">KERN_ALERT</a> \"%s: journal block not found \"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>\"at offset %u on %s\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__func__\">__func__</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#blocknr\">blocknr</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#bdevname\">bdevname</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a>, <a class=\"id\" href=\"#b\">b</a>));", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = -<a class=\"id\" href=\"#EIO\">EIO</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__journal_abort_soft\">__journal_abort_soft</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#err\">err</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/>*<a class=\"id\" href=\"#retp\">retp</a> = <a class=\"id\" href=\"#blocknr\">blocknr</a>; <span class=\"comment\">/* +journal-&gt;j_blk_offset */</span>", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * We play buffer_head aliasing tricks to write data/metadata blocks to</span>", 
"<span class=\"comment\"> * the journal without copying their contents, but for journal</span>", 
"<span class=\"comment\"> * descriptor blocks we do need to generate bona fide buffers.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * After the caller of journal_get_descriptor_buffer() has finished modifying</span>", 
"<span class=\"comment\"> * the buffer's contents they really should run flush_dcache_page(bh-&gt;b_page).</span>", 
"<span class=\"comment\"> * But we don't bother doing that, so there will be coherency problems with</span>", 
"<span class=\"comment\"> * mmaps of blockdevs which hold live JBD-controlled filesystems.</span>", 
"<span class=\"comment\"> */</span>", 
"struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#journal_get_descriptor_buffer\">journal_get_descriptor_buffer</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>;", 
"<span class=\"ts\"/>unsigned int <a class=\"id\" href=\"#blocknr\">blocknr</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#journal_next_log_block\">journal_next_log_block</a>(<a class=\"id\" href=\"#journal\">journal</a>, &amp;<a class=\"id\" href=\"#blocknr\">blocknr</a>);", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#__getblk\">__getblk</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a>, <a class=\"id\" href=\"#blocknr\">blocknr</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#bh\">bh</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#lock_buffer\">lock_buffer</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#memset\">memset</a>(<a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_data\">b_data</a>, 0, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#set_buffer_uptodate\">set_buffer_uptodate</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#unlock_buffer\">unlock_buffer</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#BUFFER_TRACE\">BUFFER_TRACE</a>(<a class=\"id\" href=\"#bh\">bh</a>, \"return this buffer\");", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#journal_add_journal_head\">journal_add_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Management for journal control blocks: functions to create and</span>", 
"<span class=\"comment\"> * destroy journal_t structures, and to initialise and read existing</span>", 
"<span class=\"comment\"> * journal blocks from disk.  */</span>", 
"", 
"<span class=\"comment\">/* First: create and setup a journal_t object in memory.  We initialise</span>", 
"<span class=\"comment\"> * very few fields yet: that has to wait until we have created the</span>", 
"<span class=\"comment\"> * journal structures from from scratch, or loaded them from disk. */</span>", 
"", 
"static <a class=\"id\" href=\"#journal_t\">journal_t</a> * <a class=\"id\" href=\"#journal_init_common\">journal_init_common</a> (void)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a> = <a class=\"id\" href=\"#kzalloc\">kzalloc</a>(sizeof(*<a class=\"id\" href=\"#journal\">journal</a>), <a class=\"id\" href=\"#GFP_KERNEL\">GFP_KERNEL</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal\">journal</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#fail\">fail</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#init_waitqueue_head\">init_waitqueue_head</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_transaction_locked\">j_wait_transaction_locked</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#init_waitqueue_head\">init_waitqueue_head</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_logspace\">j_wait_logspace</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#init_waitqueue_head\">init_waitqueue_head</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_done_commit\">j_wait_done_commit</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#init_waitqueue_head\">init_waitqueue_head</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_checkpoint\">j_wait_checkpoint</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#init_waitqueue_head\">init_waitqueue_head</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_commit\">j_wait_commit</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#init_waitqueue_head\">init_waitqueue_head</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wait_updates\">j_wait_updates</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mutex_init\">mutex_init</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_barrier\">j_barrier</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mutex_init\">mutex_init</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_checkpoint_mutex\">j_checkpoint_mutex</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock_init\">spin_lock_init</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_revoke_lock\">j_revoke_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock_init\">spin_lock_init</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock_init\">spin_lock_init</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_interval\">j_commit_interval</a> = (<a class=\"id\" href=\"#HZ\">HZ</a> * <a class=\"id\" href=\"#JBD_DEFAULT_MAX_COMMIT_AGE\">JBD_DEFAULT_MAX_COMMIT_AGE</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* The journal is marked for error until we succeed with recovery! */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> = <a class=\"id\" href=\"#JFS_ABORT\">JFS_ABORT</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Set up a default-sized revoke table for the new mount. */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#journal_init_revoke\">journal_init_revoke</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#JOURNAL_REVOKE_DEFAULT_HASH\">JOURNAL_REVOKE_DEFAULT_HASH</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#kfree\">kfree</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#fail\">fail</a>;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#journal\">journal</a>;", 
"<a class=\"id\" href=\"#fail\">fail</a>:", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"}", 
"", 
"<span class=\"comment\">/* journal_init_dev and journal_init_inode:</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Create a journal structure assigned some fixed set of disk blocks to</span>", 
"<span class=\"comment\"> * the journal.  We don't actually touch those disk blocks yet, but we</span>", 
"<span class=\"comment\"> * need to set up all of the mapping information to tell the journaling</span>", 
"<span class=\"comment\"> * system where the journal blocks are.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> *  journal_t * journal_init_dev() - creates and initialises a journal structure</span>", 
"<span class=\"comment\"> *  @bdev: Block device on which to create the journal</span>", 
"<span class=\"comment\"> *  @fs_dev: Device which hold journalled filesystem for this journal.</span>", 
"<span class=\"comment\"> *  @start: Block nr Start of journal.</span>", 
"<span class=\"comment\"> *  @len:  Length of the journal in blocks.</span>", 
"<span class=\"comment\"> *  @blocksize: blocksize of journalling device</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> *  Returns: a newly created journal_t *</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> *  journal_init_dev creates a journal which maps a fixed contiguous</span>", 
"<span class=\"comment\"> *  range of blocks on an arbitrary block device.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> */</span>", 
"<a class=\"id\" href=\"#journal_t\">journal_t</a> * <a class=\"id\" href=\"#journal_init_dev\">journal_init_dev</a>(struct <a class=\"id\" href=\"#block_device\">block_device</a> *<a class=\"id\" href=\"#bdev\">bdev</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>struct <a class=\"id\" href=\"#block_device\">block_device</a> *<a class=\"id\" href=\"#fs_dev\">fs_dev</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>int <a class=\"id\" href=\"#start\">start</a>, int <a class=\"id\" href=\"#len\">len</a>, int <a class=\"id\" href=\"#blocksize\">blocksize</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a> = <a class=\"id\" href=\"#journal_init_common\">journal_init_common</a>();", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#n\">n</a>;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal\">journal</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* journal descriptor can store up to n blocks -bzzz */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a> = <a class=\"id\" href=\"#blocksize\">blocksize</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#n\">n</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a> / sizeof(<a class=\"id\" href=\"#journal_block_tag_t\">journal_block_tag_t</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbufsize\">j_wbufsize</a> = <a class=\"id\" href=\"#n\">n</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbuf\">j_wbuf</a> = <a class=\"id\" href=\"#kmalloc\">kmalloc</a>(<a class=\"id\" href=\"#n\">n</a> * sizeof(struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a>*), <a class=\"id\" href=\"#GFP_KERNEL\">GFP_KERNEL</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbuf\">j_wbuf</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a> \"%s: Cant allocate bhs for commit thread\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out_err\">out_err</a>;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a> = <a class=\"id\" href=\"#bdev\">bdev</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_fs_dev\">j_fs_dev</a> = <a class=\"id\" href=\"#fs_dev\">fs_dev</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blk_offset\">j_blk_offset</a> = <a class=\"id\" href=\"#start\">start</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a> = <a class=\"id\" href=\"#len\">len</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#__getblk\">__getblk</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a>, <a class=\"id\" href=\"#start\">start</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#bh\">bh</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a>", 
"<span class=\"ts\"/><span class=\"ts\"/>       \"%s: Cannot get buffer for journal superblock\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>       <a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out_err\">out_err</a>;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a> = <a class=\"id\" href=\"#bh\">bh</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a> = (<a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *)<a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_data\">b_data</a>;", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#journal\">journal</a>;", 
"<a class=\"id\" href=\"#out_err\">out_err</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kfree\">kfree</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbuf\">j_wbuf</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kfree\">kfree</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> *  journal_t * journal_init_inode () - creates a journal which maps to a inode.</span>", 
"<span class=\"comment\"> *  @inode: An inode to create the journal in</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * journal_init_inode creates a journal which maps an on-disk inode as</span>", 
"<span class=\"comment\"> * the journal.  The inode must exist already, must support bmap() and</span>", 
"<span class=\"comment\"> * must have all data blocks preallocated.</span>", 
"<span class=\"comment\"> */</span>", 
"<a class=\"id\" href=\"#journal_t\">journal_t</a> * <a class=\"id\" href=\"#journal_init_inode\">journal_init_inode</a> (struct <a class=\"id\" href=\"#inode\">inode</a> *<a class=\"id\" href=\"#inode\">inode</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a> = <a class=\"id\" href=\"#journal_init_common\">journal_init_common</a>();", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#n\">n</a>;", 
"<span class=\"ts\"/>unsigned int <a class=\"id\" href=\"#blocknr\">blocknr</a>;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal\">journal</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_fs_dev\">j_fs_dev</a> = <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_sb\">i_sb</a>-><a class=\"id\" href=\"#s_bdev\">s_bdev</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_inode\">j_inode</a> = <a class=\"id\" href=\"#inode\">inode</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1,", 
"<span class=\"ts\"/><span class=\"ts\"/>  \"journal %p: inode %s/%ld, size %Ld, bits %d, blksize %ld\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_sb\">i_sb</a>-><a class=\"id\" href=\"#s_id\">s_id</a>, <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_ino\">i_ino</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/>  (long long) <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_size\">i_size</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_sb\">i_sb</a>-><a class=\"id\" href=\"#s_blocksize_bits\">s_blocksize_bits</a>, <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_sb\">i_sb</a>-><a class=\"id\" href=\"#s_blocksize\">s_blocksize</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a> = <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_size\">i_size</a> >> <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_sb\">i_sb</a>-><a class=\"id\" href=\"#s_blocksize_bits\">s_blocksize_bits</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a> = <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_sb\">i_sb</a>-><a class=\"id\" href=\"#s_blocksize\">s_blocksize</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* journal descriptor can store up to n blocks -bzzz */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#n\">n</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a> / sizeof(<a class=\"id\" href=\"#journal_block_tag_t\">journal_block_tag_t</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbufsize\">j_wbufsize</a> = <a class=\"id\" href=\"#n\">n</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbuf\">j_wbuf</a> = <a class=\"id\" href=\"#kmalloc\">kmalloc</a>(<a class=\"id\" href=\"#n\">n</a> * sizeof(struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a>*), <a class=\"id\" href=\"#GFP_KERNEL\">GFP_KERNEL</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbuf\">j_wbuf</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a> \"%s: Cant allocate bhs for commit thread\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out_err\">out_err</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#journal_bmap\">journal_bmap</a>(<a class=\"id\" href=\"#journal\">journal</a>, 0, &amp;<a class=\"id\" href=\"#blocknr\">blocknr</a>);", 
"<span class=\"ts\"/><span class=\"comment\">/* If that failed, give up */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a> \"%s: Cannnot locate journal superblock\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>       <a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out_err\">out_err</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#__getblk\">__getblk</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a>, <a class=\"id\" href=\"#blocknr\">blocknr</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#bh\">bh</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a>", 
"<span class=\"ts\"/><span class=\"ts\"/>       \"%s: Cannot get buffer for journal superblock\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>       <a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out_err\">out_err</a>;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a> = <a class=\"id\" href=\"#bh\">bh</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a> = (<a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *)<a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_data\">b_data</a>;", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#journal\">journal</a>;", 
"<a class=\"id\" href=\"#out_err\">out_err</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kfree\">kfree</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbuf\">j_wbuf</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kfree\">kfree</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * If the journal init or create aborts, we need to mark the journal</span>", 
"<span class=\"comment\"> * superblock as being NULL to prevent the journal destroy from writing</span>", 
"<span class=\"comment\"> * back a bogus superblock.</span>", 
"<span class=\"comment\"> */</span>", 
"static void <a class=\"id\" href=\"#journal_fail_superblock\">journal_fail_superblock</a> (<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#brelse\">brelse</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Given a journal_t structure, initialise the various fields for</span>", 
"<span class=\"comment\"> * startup of a new journaling session.  We use this both when creating</span>", 
"<span class=\"comment\"> * a journal, and after recovering an old journal to reset it for</span>", 
"<span class=\"comment\"> * subsequent use.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"static int <a class=\"id\" href=\"#journal_reset\">journal_reset</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"<span class=\"ts\"/>unsigned int <a class=\"id\" href=\"#first\">first</a>, <a class=\"id\" href=\"#last\">last</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#first\">first</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_first\">s_first</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#last\">last</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_maxlen\">s_maxlen</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#first\">first</a> + <a class=\"id\" href=\"#JFS_MIN_JOURNAL_BLOCKS\">JFS_MIN_JOURNAL_BLOCKS</a> &gt; <a class=\"id\" href=\"#last\">last</a> + 1) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a> \"JBD: Journal too short (blocks %u-%u).\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>       <a class=\"id\" href=\"#first\">first</a>, <a class=\"id\" href=\"#last\">last</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_fail_superblock\">journal_fail_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#EINVAL\">EINVAL</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_first\">j_first</a> = <a class=\"id\" href=\"#first\">first</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_last\">j_last</a> = <a class=\"id\" href=\"#last\">last</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_head\">j_head</a> = <a class=\"id\" href=\"#first\">first</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a> = <a class=\"id\" href=\"#first\">first</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_free\">j_free</a> = <a class=\"id\" href=\"#last\">last</a> - <a class=\"id\" href=\"#first\">first</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail_sequence\">j_tail_sequence</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_transaction_sequence\">j_transaction_sequence</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_transaction_sequence\">j_transaction_sequence</a> - 1;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_request\">j_commit_request</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_commit_sequence\">j_commit_sequence</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_max_transaction_buffers\">j_max_transaction_buffers</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a> / 4;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Add the dynamic fields and write it to disk. */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_update_superblock\">journal_update_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>, 1);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#journal_start_thread\">journal_start_thread</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_create() - Initialise the new journal file</span>", 
"<span class=\"comment\"> * @journal: Journal to create. This structure must have been initialised</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Given a journal_t structure which tells us which disk blocks we can</span>", 
"<span class=\"comment\"> * use, create a new journal superblock and initialise all of the</span>", 
"<span class=\"comment\"> * journal fields from scratch.</span>", 
"<span class=\"comment\"> **/</span>", 
"int <a class=\"id\" href=\"#journal_create\">journal_create</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>unsigned int <a class=\"id\" href=\"#blocknr\">blocknr</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#i\">i</a>, <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a> &lt; <a class=\"id\" href=\"#JFS_MIN_JOURNAL_BLOCKS\">JFS_MIN_JOURNAL_BLOCKS</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a> (<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a> \"Journal length (%d blocks) too short.\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_fail_superblock\">journal_fail_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#EINVAL\">EINVAL</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_inode\">j_inode</a> == <a class=\"id\" href=\"#NULL\">NULL</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> * We don't know what block to start at!</span>", 
"<span class=\"comment\"><span class=\"ts\"/><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_EMERG\">KERN_EMERG</a>", 
"<span class=\"ts\"/><span class=\"ts\"/>       \"%s: creation of journal on external device!\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>       <a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#BUG\">BUG</a>();", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Zero out the entire journal on disk.  We cannot afford to</span>", 
"<span class=\"comment\"><span class=\"ts\"/>   have any blocks on disk beginning with JFS_MAGIC_NUMBER. */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"JBD: Zeroing out journal blocks...\\n\");", 
"<span class=\"ts\"/>for (<a class=\"id\" href=\"#i\">i</a> = 0; <a class=\"id\" href=\"#i\">i</a> &lt; <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a>; <a class=\"id\" href=\"#i\">i</a>++) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#journal_bmap\">journal_bmap</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#i\">i</a>, &amp;<a class=\"id\" href=\"#blocknr\">blocknr</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#__getblk\">__getblk</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a>, <a class=\"id\" href=\"#blocknr\">blocknr</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#lock_buffer\">lock_buffer</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#memset\">memset</a> (<a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_data\">b_data</a>, 0, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#BUFFER_TRACE\">BUFFER_TRACE</a>(<a class=\"id\" href=\"#bh\">bh</a>, \"marking dirty\");", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#mark_buffer_dirty\">mark_buffer_dirty</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#BUFFER_TRACE\">BUFFER_TRACE</a>(<a class=\"id\" href=\"#bh\">bh</a>, \"marking uptodate\");", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#set_buffer_uptodate\">set_buffer_uptodate</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#unlock_buffer\">unlock_buffer</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__brelse\">__brelse</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sync_blockdev\">sync_blockdev</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"JBD: journal cleared.\\n\");", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* OK, fill in the initial static fields in the new superblock */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_header\">s_header</a>.<a class=\"id\" href=\"#h_magic\">h_magic</a><span class=\"ts\"/> = <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#JFS_MAGIC_NUMBER\">JFS_MAGIC_NUMBER</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_header\">s_header</a>.<a class=\"id\" href=\"#h_blocktype\">h_blocktype</a> = <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#JFS_SUPERBLOCK_V2\">JFS_SUPERBLOCK_V2</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_blocksize\">s_blocksize</a><span class=\"ts\"/>= <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_maxlen\">s_maxlen</a><span class=\"ts\"/>= <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_first\">s_first</a><span class=\"ts\"/>= <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(1);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_transaction_sequence\">j_transaction_sequence</a> = 1;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &= ~<a class=\"id\" href=\"#JFS_ABORT\">JFS_ABORT</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_format_version\">j_format_version</a> = 2;", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#journal_reset\">journal_reset</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * void journal_update_superblock() - Update journal sb on disk.</span>", 
"<span class=\"comment\"> * @journal: The journal to update.</span>", 
"<span class=\"comment\"> * @wait: Set to '0' if you don't want to wait for IO completion.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Update a journal's dynamic superblock fields and write it to disk,</span>", 
"<span class=\"comment\"> * optionally waiting for the IO to complete.</span>", 
"<span class=\"comment\"> */</span>", 
"void <a class=\"id\" href=\"#journal_update_superblock\">journal_update_superblock</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, int <a class=\"id\" href=\"#wait\">wait</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/*</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * As a special case, if the on-disk copy is already marked as needing</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * no recovery (s_start == 0) and there are no outstanding transactions</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * in the filesystem, then we can safely defer the superblock update</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * until the next commit by setting JFS_FLUSHED.  This avoids</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * attempting a write to a potential-readonly device.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_start\">s_start</a> == 0 && <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail_sequence\">j_tail_sequence</a> ==", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_transaction_sequence\">j_transaction_sequence</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1,\"JBD: Skipping superblock update on recovered sb \"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>\"(start %u, seq %d, errno %d)\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail_sequence\">j_tail_sequence</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out\">out</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1,\"JBD: updating superblock (start %u, seq %d, errno %d)\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail_sequence\">j_tail_sequence</a>, <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_sequence\">s_sequence</a> = <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail_sequence\">j_tail_sequence</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_start\">s_start</a>    = <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_errno\">s_errno</a>    = <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#BUFFER_TRACE\">BUFFER_TRACE</a>(<a class=\"id\" href=\"#bh\">bh</a>, \"marking dirty\");", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mark_buffer_dirty\">mark_buffer_dirty</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#wait\">wait</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#sync_dirty_buffer\">sync_dirty_buffer</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>else", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#write_dirty_buffer\">write_dirty_buffer</a>(<a class=\"id\" href=\"#bh\">bh</a>, <a class=\"id\" href=\"#WRITE\">WRITE</a>);", 
"", 
"<a class=\"id\" href=\"#out\">out</a>:", 
"<span class=\"ts\"/><span class=\"comment\">/* If we have just flushed the log (by marking s_start==0), then</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * any future commit will have to be careful to update the</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * superblock again to re-record the true start of the log. */</span>", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_start\">s_start</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &= ~<a class=\"id\" href=\"#JFS_FLUSHED\">JFS_FLUSHED</a>;", 
"<span class=\"ts\"/>else", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> |= <a class=\"id\" href=\"#JFS_FLUSHED\">JFS_FLUSHED</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Read the superblock for a given journal, performing initial</span>", 
"<span class=\"comment\"> * validation of the format.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"static int <a class=\"id\" href=\"#journal_get_superblock\">journal_get_superblock</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a> = -<a class=\"id\" href=\"#EIO\">EIO</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(<a class=\"id\" href=\"#bh\">bh</a> != <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#buffer_uptodate\">buffer_uptodate</a>(<a class=\"id\" href=\"#bh\">bh</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ll_rw_block\">ll_rw_block</a>(<a class=\"id\" href=\"#READ\">READ</a>, 1, &amp;<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#wait_on_buffer\">wait_on_buffer</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#buffer_uptodate\">buffer_uptodate</a>(<a class=\"id\" href=\"#bh\">bh</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a> (<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>\"JBD: IO error reading journal superblock\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out\">out</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = -<a class=\"id\" href=\"#EINVAL\">EINVAL</a>;", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_header\">s_header</a>.<a class=\"id\" href=\"#h_magic\">h_magic</a> != <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#JFS_MAGIC_NUMBER\">JFS_MAGIC_NUMBER</a>) ||", 
"<span class=\"ts\"/>    <a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_blocksize\">s_blocksize</a> != <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_blocksize\">j_blocksize</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a> \"JBD: no valid journal superblock found\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out\">out</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>switch(<a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_header\">s_header</a>.<a class=\"id\" href=\"#h_blocktype\">h_blocktype</a>)) {", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#JFS_SUPERBLOCK_V1\">JFS_SUPERBLOCK_V1</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_format_version\">j_format_version</a> = 1;", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#JFS_SUPERBLOCK_V2\">JFS_SUPERBLOCK_V2</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_format_version\">j_format_version</a> = 2;", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/>default:", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a> \"JBD: unrecognised superblock format ID\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out\">out</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_maxlen\">s_maxlen</a>) &lt; <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_maxlen\">s_maxlen</a>);", 
"<span class=\"ts\"/>else if (<a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_maxlen\">s_maxlen</a>) &gt; <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_maxlen\">j_maxlen</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a> (<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a> \"JBD: journal file too short\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#out\">out</a>;", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>return 0;", 
"", 
"<a class=\"id\" href=\"#out\">out</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_fail_superblock\">journal_fail_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Load the on-disk journal superblock and read the key fields into the</span>", 
"<span class=\"comment\"> * journal_t.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"static int <a class=\"id\" href=\"#load_superblock\">load_superblock</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#journal_get_superblock\">journal_get_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail_sequence\">j_tail_sequence</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_sequence\">s_sequence</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_start\">s_start</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_first\">j_first</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_first\">s_first</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_last\">j_last</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_maxlen\">s_maxlen</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_errno\">s_errno</a>);", 
"", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_load() - Read journal from disk.</span>", 
"<span class=\"comment\"> * @journal: Journal to act on.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Given a journal_t structure which tells us which disk blocks contain</span>", 
"<span class=\"comment\"> * a journal, read the journal from disk to initialise the in-memory</span>", 
"<span class=\"comment\"> * structures.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_load\">journal_load</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#load_superblock\">load_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"<span class=\"ts\"/><span class=\"comment\">/* If this is a V2 superblock, then we have to check the</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * features flags on it. */</span>", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_format_version\">j_format_version</a> >= 2) {", 
"<span class=\"ts\"/><span class=\"ts\"/>if ((<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_ro_compat\">s_feature_ro_compat</a> &amp;", 
"<span class=\"ts\"/><span class=\"ts\"/>     ~<a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#JFS_KNOWN_ROCOMPAT_FEATURES\">JFS_KNOWN_ROCOMPAT_FEATURES</a>)) ||", 
"<span class=\"ts\"/><span class=\"ts\"/>    (<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_incompat\">s_feature_incompat</a> &amp;", 
"<span class=\"ts\"/><span class=\"ts\"/>     ~<a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#JFS_KNOWN_INCOMPAT_FEATURES\">JFS_KNOWN_INCOMPAT_FEATURES</a>))) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a> (<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>\"JBD: Unrecognised features on journal\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#EINVAL\">EINVAL</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Let the recovery code check whether it needs to recover any</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * data from the journal. */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal_recover\">journal_recover</a>(<a class=\"id\" href=\"#journal\">journal</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#recovery_error\">recovery_error</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* OK, we've finished with the dynamic journal bits:</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * reinitialise the dynamic contents of the superblock in memory</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * and reset them on disk. */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal_reset\">journal_reset</a>(<a class=\"id\" href=\"#journal\">journal</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#recovery_error\">recovery_error</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &= ~<a class=\"id\" href=\"#JFS_ABORT\">JFS_ABORT</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> |= <a class=\"id\" href=\"#JFS_LOADED\">JFS_LOADED</a>;", 
"<span class=\"ts\"/>return 0;", 
"", 
"<a class=\"id\" href=\"#recovery_error\">recovery_error</a>:", 
"<span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a> (<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a> \"JBD: recovery failed\\n\");", 
"<span class=\"ts\"/>return -<a class=\"id\" href=\"#EIO\">EIO</a>;", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * void journal_destroy() - Release a journal_t structure.</span>", 
"<span class=\"comment\"> * @journal: Journal to act on.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Release a journal_t structure once it is no longer in use by the</span>", 
"<span class=\"comment\"> * journaled object.</span>", 
"<span class=\"comment\"> * Return &lt;0 if we couldn't clean up the journal.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_destroy\">journal_destroy</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a> = 0;", 
"", 
"<span class=\"ts\"/>", 
"<span class=\"ts\"/><span class=\"comment\">/* Wait for the commit thread to wake up and die. */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_kill_thread\">journal_kill_thread</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Force a final log commit */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_commit_transaction\">journal_commit_transaction</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Force any old transactions to disk */</span>", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Totally anal locking here... */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/>while (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_checkpoint_transactions\">j_checkpoint_transactions</a> != <a class=\"id\" href=\"#NULL\">NULL</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#log_do_checkpoint\">log_do_checkpoint</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a> == <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a> == <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_checkpoint_transactions\">j_checkpoint_transactions</a> == <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#is_journal_aborted\">is_journal_aborted</a>(<a class=\"id\" href=\"#journal\">journal</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* We can now mark the journal as empty. */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a> = 0;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail_sequence\">j_tail_sequence</a> =", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>++<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_transaction_sequence\">j_transaction_sequence</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_update_superblock\">journal_update_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>, 1);", 
"<span class=\"ts\"/><span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = -<a class=\"id\" href=\"#EIO\">EIO</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#brelse\">brelse</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_inode\">j_inode</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#iput\">iput</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_inode\">j_inode</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_revoke\">j_revoke</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_destroy_revoke\">journal_destroy_revoke</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kfree\">kfree</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_wbuf\">j_wbuf</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kfree\">kfree</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"}", 
"", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> *int journal_check_used_features () - Check if features specified are used.</span>", 
"<span class=\"comment\"> * @journal: Journal to check.</span>", 
"<span class=\"comment\"> * @compat: bitmask of compatible features</span>", 
"<span class=\"comment\"> * @ro: bitmask of features that force read-only mount</span>", 
"<span class=\"comment\"> * @incompat: bitmask of incompatible features</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Check whether the journal uses all of a given set of</span>", 
"<span class=\"comment\"> * features.  Return true (non-zero) if it does.</span>", 
"<span class=\"comment\"> **/</span>", 
"", 
"int <a class=\"id\" href=\"#journal_check_used_features\">journal_check_used_features</a> (<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, unsigned long <a class=\"id\" href=\"#compat\">compat</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/> unsigned long <a class=\"id\" href=\"#ro\">ro</a>, unsigned long <a class=\"id\" href=\"#incompat\">incompat</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a>;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#compat\">compat</a> && !<a class=\"id\" href=\"#ro\">ro</a> && !<a class=\"id\" href=\"#incompat\">incompat</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return 1;", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_format_version\">j_format_version</a> == 1)", 
"<span class=\"ts\"/><span class=\"ts\"/>return 0;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"", 
"<span class=\"ts\"/>if (((<a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_compat\">s_feature_compat</a>) &amp; <a class=\"id\" href=\"#compat\">compat</a>) == <a class=\"id\" href=\"#compat\">compat</a>) &&", 
"<span class=\"ts\"/>    ((<a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_ro_compat\">s_feature_ro_compat</a>) &amp; <a class=\"id\" href=\"#ro\">ro</a>) == <a class=\"id\" href=\"#ro\">ro</a>) &&", 
"<span class=\"ts\"/>    ((<a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_incompat\">s_feature_incompat</a>) &amp; <a class=\"id\" href=\"#incompat\">incompat</a>) == <a class=\"id\" href=\"#incompat\">incompat</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>return 1;", 
"", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_check_available_features() - Check feature set in journalling layer</span>", 
"<span class=\"comment\"> * @journal: Journal to check.</span>", 
"<span class=\"comment\"> * @compat: bitmask of compatible features</span>", 
"<span class=\"comment\"> * @ro: bitmask of features that force read-only mount</span>", 
"<span class=\"comment\"> * @incompat: bitmask of incompatible features</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Check whether the journaling code supports the use of</span>", 
"<span class=\"comment\"> * all of a given set of features on this journal.  Return true</span>", 
"<span class=\"comment\"> * (non-zero) if it can. */</span>", 
"", 
"int <a class=\"id\" href=\"#journal_check_available_features\">journal_check_available_features</a> (<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, unsigned long <a class=\"id\" href=\"#compat\">compat</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>      unsigned long <a class=\"id\" href=\"#ro\">ro</a>, unsigned long <a class=\"id\" href=\"#incompat\">incompat</a>)", 
"{", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#compat\">compat</a> && !<a class=\"id\" href=\"#ro\">ro</a> && !<a class=\"id\" href=\"#incompat\">incompat</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return 1;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* We can support any known requested features iff the</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * superblock is in version 2.  Otherwise we fail to support any</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * extended sb features. */</span>", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_format_version\">j_format_version</a> != 2)", 
"<span class=\"ts\"/><span class=\"ts\"/>return 0;", 
"", 
"<span class=\"ts\"/>if ((<a class=\"id\" href=\"#compat\">compat</a>   &amp; <a class=\"id\" href=\"#JFS_KNOWN_COMPAT_FEATURES\">JFS_KNOWN_COMPAT_FEATURES</a>) == <a class=\"id\" href=\"#compat\">compat</a> &&", 
"<span class=\"ts\"/>    (<a class=\"id\" href=\"#ro\">ro</a>       &amp; <a class=\"id\" href=\"#JFS_KNOWN_ROCOMPAT_FEATURES\">JFS_KNOWN_ROCOMPAT_FEATURES</a>) == <a class=\"id\" href=\"#ro\">ro</a> &&", 
"<span class=\"ts\"/>    (<a class=\"id\" href=\"#incompat\">incompat</a> &amp; <a class=\"id\" href=\"#JFS_KNOWN_INCOMPAT_FEATURES\">JFS_KNOWN_INCOMPAT_FEATURES</a>) == <a class=\"id\" href=\"#incompat\">incompat</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return 1;", 
"", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_set_features () - Mark a given journal feature in the superblock</span>", 
"<span class=\"comment\"> * @journal: Journal to act on.</span>", 
"<span class=\"comment\"> * @compat: bitmask of compatible features</span>", 
"<span class=\"comment\"> * @ro: bitmask of features that force read-only mount</span>", 
"<span class=\"comment\"> * @incompat: bitmask of incompatible features</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Mark a given journal feature as present on the</span>", 
"<span class=\"comment\"> * superblock.  Returns true if the requested features could be set.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"int <a class=\"id\" href=\"#journal_set_features\">journal_set_features</a> (<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, unsigned long <a class=\"id\" href=\"#compat\">compat</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>  unsigned long <a class=\"id\" href=\"#ro\">ro</a>, unsigned long <a class=\"id\" href=\"#incompat\">incompat</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a>;", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal_check_used_features\">journal_check_used_features</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#compat\">compat</a>, <a class=\"id\" href=\"#ro\">ro</a>, <a class=\"id\" href=\"#incompat\">incompat</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>return 1;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal_check_available_features\">journal_check_available_features</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#compat\">compat</a>, <a class=\"id\" href=\"#ro\">ro</a>, <a class=\"id\" href=\"#incompat\">incompat</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>return 0;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"Setting new features 0x%lx/0x%lx/0x%lx\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/>  <a class=\"id\" href=\"#compat\">compat</a>, <a class=\"id\" href=\"#ro\">ro</a>, <a class=\"id\" href=\"#incompat\">incompat</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_compat\">s_feature_compat</a>    |= <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#compat\">compat</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_ro_compat\">s_feature_ro_compat</a> |= <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#ro\">ro</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_incompat\">s_feature_incompat</a>  |= <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#incompat\">incompat</a>);", 
"", 
"<span class=\"ts\"/>return 1;", 
"}", 
"", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_update_format () - Update on-disk journal structure.</span>", 
"<span class=\"comment\"> * @journal: Journal to act on.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Given an initialised but unloaded journal struct, poke about in the</span>", 
"<span class=\"comment\"> * on-disk structure to update it to the most recent supported version.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_update_format\">journal_update_format</a> (<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a>;", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#journal_get_superblock\">journal_get_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_superblock\">j_superblock</a>;", 
"", 
"<span class=\"ts\"/>switch (<a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_header\">s_header</a>.<a class=\"id\" href=\"#h_blocktype\">h_blocktype</a>)) {", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#JFS_SUPERBLOCK_V2\">JFS_SUPERBLOCK_V2</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/>return 0;", 
"<span class=\"ts\"/>case <a class=\"id\" href=\"#JFS_SUPERBLOCK_V1\">JFS_SUPERBLOCK_V1</a>:", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#journal_convert_superblock_v1\">journal_convert_superblock_v1</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#sb\">sb</a>);", 
"<span class=\"ts\"/>default:", 
"<span class=\"ts\"/><span class=\"ts\"/>break;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>return -<a class=\"id\" href=\"#EINVAL\">EINVAL</a>;", 
"}", 
"", 
"static int <a class=\"id\" href=\"#journal_convert_superblock_v1\">journal_convert_superblock_v1</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/> <a class=\"id\" href=\"#journal_superblock_t\">journal_superblock_t</a> *<a class=\"id\" href=\"#sb\">sb</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#offset\">offset</a>, <a class=\"id\" href=\"#blocksize\">blocksize</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a>", 
"<span class=\"ts\"/><span class=\"ts\"/>\"JBD: Converting superblock from version 1 to 2.\\n\");", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Pre-initialise new fields to zero */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#offset\">offset</a> = ((char *) &amp;(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_compat\">s_feature_compat</a>)) - ((char *) <a class=\"id\" href=\"#sb\">sb</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#blocksize\">blocksize</a> = <a class=\"id\" href=\"#be32_to_cpu\">be32_to_cpu</a>(<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_blocksize\">s_blocksize</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#memset\">memset</a>(&amp;<a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_feature_compat\">s_feature_compat</a>, 0, <a class=\"id\" href=\"#blocksize\">blocksize</a>-<a class=\"id\" href=\"#offset\">offset</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_nr_users\">s_nr_users</a> = <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(1);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sb\">sb</a>-><a class=\"id\" href=\"#s_header\">s_header</a>.<a class=\"id\" href=\"#h_blocktype\">h_blocktype</a> = <a class=\"id\" href=\"#cpu_to_be32\">cpu_to_be32</a>(<a class=\"id\" href=\"#JFS_SUPERBLOCK_V2\">JFS_SUPERBLOCK_V2</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_format_version\">j_format_version</a> = 2;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_sb_buffer\">j_sb_buffer</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#BUFFER_TRACE\">BUFFER_TRACE</a>(<a class=\"id\" href=\"#bh\">bh</a>, \"marking dirty\");", 
"<span class=\"ts\"/><a class=\"id\" href=\"#mark_buffer_dirty\">mark_buffer_dirty</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#sync_dirty_buffer\">sync_dirty_buffer</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_flush () - Flush journal</span>", 
"<span class=\"comment\"> * @journal: Journal to act on.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Flush all data for a given journal to disk and empty the journal.</span>", 
"<span class=\"comment\"> * Filesystems can use this when remounting readonly to ensure that</span>", 
"<span class=\"comment\"> * recovery does not need to happen on remount.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"int <a class=\"id\" href=\"#journal_flush\">journal_flush</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a> = 0;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#transaction_t\">transaction_t</a> *<a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/>unsigned int <a class=\"id\" href=\"#old_tail\">old_tail</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Force everything buffered to the log... */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__log_start_commit\">__log_start_commit</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a>);", 
"<span class=\"ts\"/>} else if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a>;", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Wait for the log commit to complete... */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#transaction\">transaction</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#tid_t\">tid_t</a> <a class=\"id\" href=\"#tid\">tid</a> = <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a>;", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#log_wait_commit\">log_wait_commit</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#tid\">tid</a>);", 
"<span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* ...and flush everything in the log out to disk. */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/>while (!<a class=\"id\" href=\"#err\">err</a> && <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_checkpoint_transactions\">j_checkpoint_transactions</a> != <a class=\"id\" href=\"#NULL\">NULL</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#mutex_lock\">mutex_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_checkpoint_mutex\">j_checkpoint_mutex</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#log_do_checkpoint\">log_do_checkpoint</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#mutex_unlock\">mutex_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_checkpoint_mutex\">j_checkpoint_mutex</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_list_lock\">j_list_lock</a>);", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#is_journal_aborted\">is_journal_aborted</a>(<a class=\"id\" href=\"#journal\">journal</a>))", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#EIO\">EIO</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#cleanup_journal_tail\">cleanup_journal_tail</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"", 
"<span class=\"ts\"/><span class=\"comment\">/* Finally, mark the journal as really needing no recovery.</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * This sets s_start==0 in the underlying superblock, which is</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * the magic code for a fully-recovered superblock.  Any future</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * commits of data to the journal will restore the current</span>", 
"<span class=\"comment\"><span class=\"ts\"/> * s_start value. */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#old_tail\">old_tail</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a> = 0;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_update_superblock\">journal_update_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>, 1);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a> = <a class=\"id\" href=\"#old_tail\">old_tail</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(!<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(!<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_committing_transaction\">j_committing_transaction</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(!<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_checkpoint_transactions\">j_checkpoint_transactions</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_head\">j_head</a> == <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail_sequence\">j_tail_sequence</a> == <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_transaction_sequence\">j_transaction_sequence</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_wipe() - Wipe journal contents</span>", 
"<span class=\"comment\"> * @journal: Journal to act on.</span>", 
"<span class=\"comment\"> * @write: flag (see below)</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Wipe out all of the contents of a journal, safely.  This will produce</span>", 
"<span class=\"comment\"> * a warning if the journal contains any valid recovery information.</span>", 
"<span class=\"comment\"> * Must be called between journal_init_*() and journal_load().</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * If 'write' is non-zero, then we wipe out the journal on disk; otherwise</span>", 
"<span class=\"comment\"> * we merely suppress recovery.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"int <a class=\"id\" href=\"#journal_wipe\">journal_wipe</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, int <a class=\"id\" href=\"#write\">write</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a> = 0;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a> (!(<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &amp; <a class=\"id\" href=\"#JFS_LOADED\">JFS_LOADED</a>));", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#load_superblock\">load_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#err\">err</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_tail\">j_tail</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#no_recovery\">no_recovery</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a> (<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a> \"JBD: %s recovery information on journal\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#write\">write</a> ? \"Clearing\" : \"Ignoring\");", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#journal_skip_recovery\">journal_skip_recovery</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#write\">write</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_update_superblock\">journal_update_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>, 1);", 
"", 
" <a class=\"id\" href=\"#no_recovery\">no_recovery</a>:", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * journal_dev_name: format a character string to describe on what</span>", 
"<span class=\"comment\"> * device this journal is present.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"static const char *<a class=\"id\" href=\"#journal_dev_name\">journal_dev_name</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, char *<a class=\"id\" href=\"#buffer\">buffer</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#block_device\">block_device</a> *<a class=\"id\" href=\"#bdev\">bdev</a>;", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_inode\">j_inode</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#bdev\">bdev</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_inode\">j_inode</a>-><a class=\"id\" href=\"#i_sb\">i_sb</a>-><a class=\"id\" href=\"#s_bdev\">s_bdev</a>;", 
"<span class=\"ts\"/>else", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#bdev\">bdev</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_dev\">j_dev</a>;", 
"", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#bdevname\">bdevname</a>(<a class=\"id\" href=\"#bdev\">bdev</a>, <a class=\"id\" href=\"#buffer\">buffer</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Journal abort has very specific semantics, which we describe</span>", 
"<span class=\"comment\"> * for journal abort.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Two internal function, which provide abort to te jbd layer</span>", 
"<span class=\"comment\"> * itself are here.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Quick version for internal journal use (doesn't lock the journal).</span>", 
"<span class=\"comment\"> * Aborts hard --- we mark the abort as occurred, but do _nothing_ else,</span>", 
"<span class=\"comment\"> * and don't attempt to make any other journal updates.</span>", 
"<span class=\"comment\"> */</span>", 
"static void <a class=\"id\" href=\"#__journal_abort_hard\">__journal_abort_hard</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#transaction_t\">transaction_t</a> *<a class=\"id\" href=\"#transaction\">transaction</a>;", 
"<span class=\"ts\"/>char <a class=\"id\" href=\"#b\">b</a>[<a class=\"id\" href=\"#BDEVNAME_SIZE\">BDEVNAME_SIZE</a>];", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &amp; <a class=\"id\" href=\"#JFS_ABORT\">JFS_ABORT</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_ERR\">KERN_ERR</a> \"Aborting journal on device %s.\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_dev_name\">journal_dev_name</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#b\">b</a>));", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> |= <a class=\"id\" href=\"#JFS_ABORT\">JFS_ABORT</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#transaction\">transaction</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_running_transaction\">j_running_transaction</a>;", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#transaction\">transaction</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__log_start_commit\">__log_start_commit</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#transaction\">transaction</a>-><a class=\"id\" href=\"#t_tid\">t_tid</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"}", 
"", 
"<span class=\"comment\">/* Soft abort: record the abort error status in the journal superblock,</span>", 
"<span class=\"comment\"> * but don't do any other IO. */</span>", 
"static void <a class=\"id\" href=\"#__journal_abort_soft\">__journal_abort_soft</a> (<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, int <a class=\"id\" href=\"#errno\">errno</a>)", 
"{", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &amp; <a class=\"id\" href=\"#JFS_ABORT\">JFS_ABORT</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/>return;", 
"", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a> = <a class=\"id\" href=\"#errno\">errno</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#__journal_abort_hard\">__journal_abort_hard</a>(<a class=\"id\" href=\"#journal\">journal</a>);", 
"", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#errno\">errno</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_update_superblock\">journal_update_superblock</a>(<a class=\"id\" href=\"#journal\">journal</a>, 1);", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * void journal_abort () - Shutdown the journal immediately.</span>", 
"<span class=\"comment\"> * @journal: the journal to shutdown.</span>", 
"<span class=\"comment\"> * @errno:   an error number to record in the journal indicating</span>", 
"<span class=\"comment\"> *           the reason for the shutdown.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Perform a complete, immediate shutdown of the ENTIRE</span>", 
"<span class=\"comment\"> * journal (not of a single transaction).  This operation cannot be</span>", 
"<span class=\"comment\"> * undone without closing and reopening the journal.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * The journal_abort function is intended to support higher level error</span>", 
"<span class=\"comment\"> * recovery mechanisms such as the ext2/ext3 remount-readonly error</span>", 
"<span class=\"comment\"> * mode.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Journal abort has very specific semantics.  Any existing dirty,</span>", 
"<span class=\"comment\"> * unjournaled buffers in the main filesystem will still be written to</span>", 
"<span class=\"comment\"> * disk by bdflush, but the journaling mechanism will be suspended</span>", 
"<span class=\"comment\"> * immediately and no further transaction commits will be honoured.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Any dirty, journaled buffers will be written back to disk without</span>", 
"<span class=\"comment\"> * hitting the journal.  Atomicity cannot be guaranteed on an aborted</span>", 
"<span class=\"comment\"> * filesystem, but we _do_ attempt to leave as much data as possible</span>", 
"<span class=\"comment\"> * behind for fsck to use for cleanup.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Any attempt to get a new transaction handle on a journal which is in</span>", 
"<span class=\"comment\"> * ABORT state will just result in an -EROFS error return.  A</span>", 
"<span class=\"comment\"> * journal_stop on an existing handle will return -EIO if we have</span>", 
"<span class=\"comment\"> * entered abort state during the update.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Recursive transactions are not disturbed by journal abort until the</span>", 
"<span class=\"comment\"> * final journal_stop, which will receive the -EIO error.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Finally, the journal_abort call allows the caller to supply an errno</span>", 
"<span class=\"comment\"> * which will be recorded (if possible) in the journal superblock.  This</span>", 
"<span class=\"comment\"> * allows a client to record failure conditions in the middle of a</span>", 
"<span class=\"comment\"> * transaction without having to complete the transaction to record the</span>", 
"<span class=\"comment\"> * failure to disk.  ext3_error, for example, now uses this</span>", 
"<span class=\"comment\"> * functionality.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Errors which originate from within the journaling layer will NOT</span>", 
"<span class=\"comment\"> * supply an errno; a null errno implies that absolutely no further</span>", 
"<span class=\"comment\"> * writes are done to the journal (unless there are any already in</span>", 
"<span class=\"comment\"> * progress).</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"void <a class=\"id\" href=\"#journal_abort\">journal_abort</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>, int <a class=\"id\" href=\"#errno\">errno</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#__journal_abort_soft\">__journal_abort_soft</a>(<a class=\"id\" href=\"#journal\">journal</a>, <a class=\"id\" href=\"#errno\">errno</a>);", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_errno () - returns the journal's error state.</span>", 
"<span class=\"comment\"> * @journal: journal to examine.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * This is the errno numbet set with journal_abort(), the last</span>", 
"<span class=\"comment\"> * time the journal was mounted - if the journal was stopped</span>", 
"<span class=\"comment\"> * without calling abort this will be 0.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * If the journal has been aborted on this mount time -EROFS will</span>", 
"<span class=\"comment\"> * be returned.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_errno\">journal_errno</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &amp; <a class=\"id\" href=\"#JFS_ABORT\">JFS_ABORT</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = -<a class=\"id\" href=\"#EROFS\">EROFS</a>;", 
"<span class=\"ts\"/>else", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = <a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * int journal_clear_err () - clears the journal's error state</span>", 
"<span class=\"comment\"> * @journal: journal to act on.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * An error must be cleared or Acked to take a FS out of readonly</span>", 
"<span class=\"comment\"> * mode.</span>", 
"<span class=\"comment\"> */</span>", 
"int <a class=\"id\" href=\"#journal_clear_err\">journal_clear_err</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#err\">err</a> = 0;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> &amp; <a class=\"id\" href=\"#JFS_ABORT\">JFS_ABORT</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#err\">err</a> = -<a class=\"id\" href=\"#EROFS\">EROFS</a>;", 
"<span class=\"ts\"/>else", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a> = 0;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#err\">err</a>;", 
"}", 
"", 
"<span class=\"comment\">/**</span>", 
"<span class=\"comment\"> * void journal_ack_err() - Ack journal err.</span>", 
"<span class=\"comment\"> * @journal: journal to act on.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * An error must be cleared or Acked to take a FS out of readonly</span>", 
"<span class=\"comment\"> * mode.</span>", 
"<span class=\"comment\"> */</span>", 
"void <a class=\"id\" href=\"#journal_ack_err\">journal_ack_err</a>(<a class=\"id\" href=\"#journal_t\">journal_t</a> *<a class=\"id\" href=\"#journal\">journal</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_lock\">spin_lock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_errno\">j_errno</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_flags\">j_flags</a> |= <a class=\"id\" href=\"#JFS_ACK_ERR\">JFS_ACK_ERR</a>;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#spin_unlock\">spin_unlock</a>(&amp;<a class=\"id\" href=\"#journal\">journal</a>-><a class=\"id\" href=\"#j_state_lock\">j_state_lock</a>);", 
"}", 
"", 
"int <a class=\"id\" href=\"#journal_blocks_per_page\">journal_blocks_per_page</a>(struct <a class=\"id\" href=\"#inode\">inode</a> *<a class=\"id\" href=\"#inode\">inode</a>)", 
"{", 
"<span class=\"ts\"/>return 1 << (<a class=\"id\" href=\"#PAGE_CACHE_SHIFT\">PAGE_CACHE_SHIFT</a> - <a class=\"id\" href=\"#inode\">inode</a>-><a class=\"id\" href=\"#i_sb\">i_sb</a>-><a class=\"id\" href=\"#s_blocksize_bits\">s_blocksize_bits</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Journal_head storage management</span>", 
"<span class=\"comment\"> */</span>", 
"static struct <a class=\"id\" href=\"#kmem_cache\">kmem_cache</a> *<a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a>;", 
"#<a class=\"id\" href=\"#ifdef\">ifdef</a> <a class=\"id\" href=\"#CONFIG_JBD_DEBUG\">CONFIG_JBD_DEBUG</a>", 
"static <a class=\"id\" href=\"#atomic_t\">atomic_t</a> <a class=\"id\" href=\"#nr_journal_heads\">nr_journal_heads</a> = <a class=\"id\" href=\"#ATOMIC_INIT\">ATOMIC_INIT</a>(0);", 
"#<a class=\"id\" href=\"#endif\">endif</a>", 
"", 
"static int <a class=\"id\" href=\"#journal_init_journal_head_cache\">journal_init_journal_head_cache</a>(void)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#retval\">retval</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT\">J_ASSERT</a>(<a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a> == <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a> = <a class=\"id\" href=\"#kmem_cache_create\">kmem_cache_create</a>(\"journal_head\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>sizeof(struct <a class=\"id\" href=\"#journal_head\">journal_head</a>),", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>0,<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* offset */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#SLAB_TEMPORARY\">SLAB_TEMPORARY</a>,<span class=\"ts\"/><span class=\"comment\">/* flags */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#NULL\">NULL</a>);<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* ctor */</span>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#retval\">retval</a> = 0;", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#retval\">retval</a> = -<a class=\"id\" href=\"#ENOMEM\">ENOMEM</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_EMERG\">KERN_EMERG</a> \"JBD: no memory for journal_head cache\\n\");", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#retval\">retval</a>;", 
"}", 
"", 
"static void <a class=\"id\" href=\"#journal_destroy_journal_head_cache\">journal_destroy_journal_head_cache</a>(void)", 
"{", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#kmem_cache_destroy\">kmem_cache_destroy</a>(<a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/>}", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * journal_head splicing and dicing</span>", 
"<span class=\"comment\"> */</span>", 
"static struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#journal_alloc_journal_head\">journal_alloc_journal_head</a>(void)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#ret\">ret</a>;", 
"<span class=\"ts\"/>static unsigned long <a class=\"id\" href=\"#last_warning\">last_warning</a>;", 
"", 
"#<a class=\"id\" href=\"#ifdef\">ifdef</a> <a class=\"id\" href=\"#CONFIG_JBD_DEBUG\">CONFIG_JBD_DEBUG</a>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#atomic_inc\">atomic_inc</a>(&amp;<a class=\"id\" href=\"#nr_journal_heads\">nr_journal_heads</a>);", 
"#<a class=\"id\" href=\"#endif\">endif</a>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#kmem_cache_alloc\">kmem_cache_alloc</a>(<a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a>, <a class=\"id\" href=\"#GFP_NOFS\">GFP_NOFS</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> == <a class=\"id\" href=\"#NULL\">NULL</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>(1, \"out of memory for journal_head\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#time_after\">time_after</a>(<a class=\"id\" href=\"#jiffies\">jiffies</a>, <a class=\"id\" href=\"#last_warning\">last_warning</a> + 5*<a class=\"id\" href=\"#HZ\">HZ</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_NOTICE\">KERN_NOTICE</a> \"ENOMEM in %s, retrying.\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>       <a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#last_warning\">last_warning</a> = <a class=\"id\" href=\"#jiffies\">jiffies</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/>while (<a class=\"id\" href=\"#ret\">ret</a> == <a class=\"id\" href=\"#NULL\">NULL</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#yield\">yield</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#kmem_cache_alloc\">kmem_cache_alloc</a>(<a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a>, <a class=\"id\" href=\"#GFP_NOFS\">GFP_NOFS</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"", 
"static void <a class=\"id\" href=\"#journal_free_journal_head\">journal_free_journal_head</a>(struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#jh\">jh</a>)", 
"{", 
"#<a class=\"id\" href=\"#ifdef\">ifdef</a> <a class=\"id\" href=\"#CONFIG_JBD_DEBUG\">CONFIG_JBD_DEBUG</a>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#atomic_dec\">atomic_dec</a>(&amp;<a class=\"id\" href=\"#nr_journal_heads\">nr_journal_heads</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#memset\">memset</a>(<a class=\"id\" href=\"#jh\">jh</a>, <a class=\"id\" href=\"#JBD_POISON_FREE\">JBD_POISON_FREE</a>, sizeof(*<a class=\"id\" href=\"#jh\">jh</a>));", 
"#<a class=\"id\" href=\"#endif\">endif</a>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#kmem_cache_free\">kmem_cache_free</a>(<a class=\"id\" href=\"#journal_head_cache\">journal_head_cache</a>, <a class=\"id\" href=\"#jh\">jh</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * A journal_head is attached to a buffer_head whenever JBD has an</span>", 
"<span class=\"comment\"> * interest in the buffer.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Whenever a buffer has an attached journal_head, its -&gt;b_state:BH_JBD bit</span>", 
"<span class=\"comment\"> * is set.  This bit is tested in core kernel code where we need to take</span>", 
"<span class=\"comment\"> * JBD-specific actions.  Testing the zeroness of -&gt;b_private is not reliable</span>", 
"<span class=\"comment\"> * there.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * When a buffer has its BH_JBD bit set, its -&gt;b_count is elevated by one.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * When a buffer has its BH_JBD bit set it is immune from being released by</span>", 
"<span class=\"comment\"> * core kernel code, mainly via -&gt;b_count.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * A journal_head may be detached from its buffer_head when the journal_head's</span>", 
"<span class=\"comment\"> * b_transaction, b_cp_transaction and b_next_transaction pointers are NULL.</span>", 
"<span class=\"comment\"> * Various places in JBD call journal_remove_journal_head() to indicate that the</span>", 
"<span class=\"comment\"> * journal_head can be dropped if needed.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Various places in the kernel want to attach a journal_head to a buffer_head</span>", 
"<span class=\"comment\"> * _before_ attaching the journal_head to a transaction.  To protect the</span>", 
"<span class=\"comment\"> * journal_head in this situation, journal_add_journal_head elevates the</span>", 
"<span class=\"comment\"> * journal_head's b_jcount refcount by one.  The caller must call</span>", 
"<span class=\"comment\"> * journal_put_journal_head() to undo this.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * So the typical usage would be:</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> *<span class=\"ts\"/>(Attach a journal_head if needed.  Increments b_jcount)</span>", 
"<span class=\"comment\"> *<span class=\"ts\"/>struct journal_head *jh = journal_add_journal_head(bh);</span>", 
"<span class=\"comment\"> *<span class=\"ts\"/>...</span>", 
"<span class=\"comment\"> *<span class=\"ts\"/>jh-&gt;b_transaction = xxx;</span>", 
"<span class=\"comment\"> *<span class=\"ts\"/>journal_put_journal_head(jh);</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Now, the journal_head's b_jcount is zero, but it is safe from being released</span>", 
"<span class=\"comment\"> * because it has a non-zero b_transaction.</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Give a buffer_head a journal_head.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * Doesn't need the journal lock.</span>", 
"<span class=\"comment\"> * May sleep.</span>", 
"<span class=\"comment\"> */</span>", 
"struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#journal_add_journal_head\">journal_add_journal_head</a>(struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#jh\">jh</a>;", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#new_jh\">new_jh</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"", 
"<a class=\"id\" href=\"#repeat\">repeat</a>:", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#buffer_jbd\">buffer_jbd</a>(<a class=\"id\" href=\"#bh\">bh</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new_jh\">new_jh</a> = <a class=\"id\" href=\"#journal_alloc_journal_head\">journal_alloc_journal_head</a>();", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#memset\">memset</a>(<a class=\"id\" href=\"#new_jh\">new_jh</a>, 0, sizeof(*<a class=\"id\" href=\"#new_jh\">new_jh</a>));", 
"<span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_lock_bh_journal_head\">jbd_lock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#buffer_jbd\">buffer_jbd</a>(<a class=\"id\" href=\"#bh\">bh</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a> = <a class=\"id\" href=\"#bh2jh\">bh2jh</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT_BH\">J_ASSERT_BH</a>(<a class=\"id\" href=\"#bh\">bh</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>(<a class=\"id\" href=\"#atomic_read\">atomic_read</a>(&amp;<a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_count\">b_count</a>) &gt; 0) ||", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>(<a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_page\">b_page</a> && <a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_page\">b_page</a>-><a class=\"id\" href=\"#mapping\">mapping</a>));", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/>if (!<a class=\"id\" href=\"#new_jh\">new_jh</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_unlock_bh_journal_head\">jbd_unlock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>goto <a class=\"id\" href=\"#repeat\">repeat</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a> = <a class=\"id\" href=\"#new_jh\">new_jh</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#new_jh\">new_jh</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* We consumed it */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#set_buffer_jbd\">set_buffer_jbd</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_private\">b_private</a> = <a class=\"id\" href=\"#jh\">jh</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_bh\">b_bh</a> = <a class=\"id\" href=\"#bh\">bh</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#get_bh\">get_bh</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#BUFFER_TRACE\">BUFFER_TRACE</a>(<a class=\"id\" href=\"#bh\">bh</a>, \"added journal_head\");", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_jcount\">b_jcount</a>++;", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_unlock_bh_journal_head\">jbd_unlock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#new_jh\">new_jh</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_free_journal_head\">journal_free_journal_head</a>(<a class=\"id\" href=\"#new_jh\">new_jh</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_private\">b_private</a>;", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Grab a ref against this buffer_head's journal_head.  If it ended up not</span>", 
"<span class=\"comment\"> * having a journal_head, return NULL</span>", 
"<span class=\"comment\"> */</span>", 
"struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#journal_grab_journal_head\">journal_grab_journal_head</a>(struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#jh\">jh</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_lock_bh_journal_head\">jbd_lock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#buffer_jbd\">buffer_jbd</a>(<a class=\"id\" href=\"#bh\">bh</a>)) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a> = <a class=\"id\" href=\"#bh2jh\">bh2jh</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_jcount\">b_jcount</a>++;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_unlock_bh_journal_head\">jbd_unlock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#jh\">jh</a>;", 
"}", 
"", 
"static void <a class=\"id\" href=\"#__journal_remove_journal_head\">__journal_remove_journal_head</a>(struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#jh\">jh</a> = <a class=\"id\" href=\"#bh2jh\">bh2jh</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT_JH\">J_ASSERT_JH</a>(<a class=\"id\" href=\"#jh\">jh</a>, <a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_jcount\">b_jcount</a> >= 0);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#get_bh\">get_bh</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_jcount\">b_jcount</a> == 0) {", 
"<span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_transaction\">b_transaction</a> == <a class=\"id\" href=\"#NULL\">NULL</a> &&", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_next_transaction\">b_next_transaction</a> == <a class=\"id\" href=\"#NULL\">NULL</a> &&", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_cp_transaction\">b_cp_transaction</a> == <a class=\"id\" href=\"#NULL\">NULL</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT_JH\">J_ASSERT_JH</a>(<a class=\"id\" href=\"#jh\">jh</a>, <a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_jlist\">b_jlist</a> == <a class=\"id\" href=\"#BJ_None\">BJ_None</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT_BH\">J_ASSERT_BH</a>(<a class=\"id\" href=\"#bh\">bh</a>, <a class=\"id\" href=\"#buffer_jbd\">buffer_jbd</a>(<a class=\"id\" href=\"#bh\">bh</a>));", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT_BH\">J_ASSERT_BH</a>(<a class=\"id\" href=\"#bh\">bh</a>, <a class=\"id\" href=\"#jh2bh\">jh2bh</a>(<a class=\"id\" href=\"#jh\">jh</a>) == <a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#BUFFER_TRACE\">BUFFER_TRACE</a>(<a class=\"id\" href=\"#bh\">bh</a>, \"remove journal_head\");", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_frozen_data\">b_frozen_data</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a> \"%s: freeing \"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>\"b_frozen_data\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_free\">jbd_free</a>(<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_frozen_data\">b_frozen_data</a>, <a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_size\">b_size</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>if (<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_committed_data\">b_committed_data</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_WARNING\">KERN_WARNING</a> \"%s: freeing \"", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>\"b_committed_data\\n\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__func__\">__func__</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_free\">jbd_free</a>(<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_committed_data\">b_committed_data</a>, <a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_size\">b_size</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#bh\">bh</a>-><a class=\"id\" href=\"#b_private\">b_private</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_bh\">b_bh</a> = <a class=\"id\" href=\"#NULL\">NULL</a>;<span class=\"ts\"/><span class=\"comment\">/* debug, really */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#clear_buffer_jbd\">clear_buffer_jbd</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__brelse\">__brelse</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_free_journal_head\">journal_free_journal_head</a>(<a class=\"id\" href=\"#jh\">jh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/>} else {", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#BUFFER_TRACE\">BUFFER_TRACE</a>(<a class=\"id\" href=\"#bh\">bh</a>, \"journal_head was locked\");", 
"<span class=\"ts\"/><span class=\"ts\"/>}", 
"<span class=\"ts\"/>}", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * journal_remove_journal_head(): if the buffer isn't attached to a transaction</span>", 
"<span class=\"comment\"> * and has a zero b_jcount then remove and release its journal_head.   If we did</span>", 
"<span class=\"comment\"> * see that the buffer is not used by any transaction we also \"logically\"</span>", 
"<span class=\"comment\"> * decrement -&gt;b_count.</span>", 
"<span class=\"comment\"> *</span>", 
"<span class=\"comment\"> * We in fact take an additional increment on -&gt;b_count as a convenience,</span>", 
"<span class=\"comment\"> * because the caller usually wants to do additional things with the bh</span>", 
"<span class=\"comment\"> * after calling here.</span>", 
"<span class=\"comment\"> * The caller of journal_remove_journal_head() *must* run __brelse(bh) at some</span>", 
"<span class=\"comment\"> * time.  Once the caller has run __brelse(), the buffer is eligible for</span>", 
"<span class=\"comment\"> * reaping by try_to_free_buffers().</span>", 
"<span class=\"comment\"> */</span>", 
"void <a class=\"id\" href=\"#journal_remove_journal_head\">journal_remove_journal_head</a>(struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a>)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_lock_bh_journal_head\">jbd_lock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#__journal_remove_journal_head\">__journal_remove_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_unlock_bh_journal_head\">jbd_unlock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Drop a reference on the passed journal_head.  If it fell to zero then try to</span>", 
"<span class=\"comment\"> * release the journal_head from the buffer_head.</span>", 
"<span class=\"comment\"> */</span>", 
"void <a class=\"id\" href=\"#journal_put_journal_head\">journal_put_journal_head</a>(struct <a class=\"id\" href=\"#journal_head\">journal_head</a> *<a class=\"id\" href=\"#jh\">jh</a>)", 
"{", 
"<span class=\"ts\"/>struct <a class=\"id\" href=\"#buffer_head\">buffer_head</a> *<a class=\"id\" href=\"#bh\">bh</a> = <a class=\"id\" href=\"#jh2bh\">jh2bh</a>(<a class=\"id\" href=\"#jh\">jh</a>);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_lock_bh_journal_head\">jbd_lock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#J_ASSERT_JH\">J_ASSERT_JH</a>(<a class=\"id\" href=\"#jh\">jh</a>, <a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_jcount\">b_jcount</a> &gt; 0);", 
"<span class=\"ts\"/>--<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_jcount\">b_jcount</a>;", 
"<span class=\"ts\"/>if (!<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_jcount\">b_jcount</a> && !<a class=\"id\" href=\"#jh\">jh</a>-><a class=\"id\" href=\"#b_transaction\">b_transaction</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__journal_remove_journal_head\">__journal_remove_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#__brelse\">__brelse</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_unlock_bh_journal_head\">jbd_unlock_bh_journal_head</a>(<a class=\"id\" href=\"#bh\">bh</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * debugfs tunables</span>", 
"<span class=\"comment\"> */</span>", 
"#<a class=\"id\" href=\"#ifdef\">ifdef</a> <a class=\"id\" href=\"#CONFIG_JBD_DEBUG\">CONFIG_JBD_DEBUG</a>", 
"", 
"<a class=\"id\" href=\"#u8\">u8</a> <a class=\"id\" href=\"#journal_enable_debug\">journal_enable_debug</a> <a class=\"id\" href=\"#__read_mostly\">__read_mostly</a>;", 
"<a class=\"id\" href=\"#EXPORT_SYMBOL\">EXPORT_SYMBOL</a>(<a class=\"id\" href=\"#journal_enable_debug\">journal_enable_debug</a>);", 
"", 
"static struct <a class=\"id\" href=\"#dentry\">dentry</a> *<a class=\"id\" href=\"#jbd_debugfs_dir\">jbd_debugfs_dir</a>;", 
"static struct <a class=\"id\" href=\"#dentry\">dentry</a> *<a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>;", 
"", 
"static void <a class=\"id\" href=\"#__init\">__init</a> <a class=\"id\" href=\"#jbd_create_debugfs_entry\">jbd_create_debugfs_entry</a>(void)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_debugfs_dir\">jbd_debugfs_dir</a> = <a class=\"id\" href=\"#debugfs_create_dir\">debugfs_create_dir</a>(\"jbd\", <a class=\"id\" href=\"#NULL\">NULL</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#jbd_debugfs_dir\">jbd_debugfs_dir</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#jbd_debug\">jbd_debug</a> = <a class=\"id\" href=\"#debugfs_create_u8\">debugfs_create_u8</a>(\"jbd-debug\", <a class=\"id\" href=\"#S_IRUGO\">S_IRUGO</a> | <a class=\"id\" href=\"#S_IWUSR\">S_IWUSR</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>       <a class=\"id\" href=\"#jbd_debugfs_dir\">jbd_debugfs_dir</a>,", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>       &amp;<a class=\"id\" href=\"#journal_enable_debug\">journal_enable_debug</a>);", 
"}", 
"", 
"static void <a class=\"id\" href=\"#__exit\">__exit</a> <a class=\"id\" href=\"#jbd_remove_debugfs_entry\">jbd_remove_debugfs_entry</a>(void)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#debugfs_remove\">debugfs_remove</a>(<a class=\"id\" href=\"#jbd_debug\">jbd_debug</a>);", 
"<span class=\"ts\"/><a class=\"id\" href=\"#debugfs_remove\">debugfs_remove</a>(<a class=\"id\" href=\"#jbd_debugfs_dir\">jbd_debugfs_dir</a>);", 
"}", 
"", 
"#else", 
"", 
"static <a class=\"id\" href=\"#inline\">inline</a> void <a class=\"id\" href=\"#jbd_create_debugfs_entry\">jbd_create_debugfs_entry</a>(void)", 
"{", 
"}", 
"", 
"static <a class=\"id\" href=\"#inline\">inline</a> void <a class=\"id\" href=\"#jbd_remove_debugfs_entry\">jbd_remove_debugfs_entry</a>(void)", 
"{", 
"}", 
"", 
"#<a class=\"id\" href=\"#endif\">endif</a>", 
"", 
"struct <a class=\"id\" href=\"#kmem_cache\">kmem_cache</a> *<a class=\"id\" href=\"#jbd_handle_cache\">jbd_handle_cache</a>;", 
"", 
"static int <a class=\"id\" href=\"#__init\">__init</a> <a class=\"id\" href=\"#journal_init_handle_cache\">journal_init_handle_cache</a>(void)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_handle_cache\">jbd_handle_cache</a> = <a class=\"id\" href=\"#kmem_cache_create\">kmem_cache_create</a>(\"journal_handle\",", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>sizeof(<a class=\"id\" href=\"#handle_t\">handle_t</a>),", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/>0,<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* offset */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#SLAB_TEMPORARY\">SLAB_TEMPORARY</a>,<span class=\"ts\"/><span class=\"comment\">/* flags */</span>", 
"<span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#NULL\">NULL</a>);<span class=\"ts\"/><span class=\"ts\"/><span class=\"comment\">/* ctor */</span>", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#jbd_handle_cache\">jbd_handle_cache</a> == <a class=\"id\" href=\"#NULL\">NULL</a>) {", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_EMERG\">KERN_EMERG</a> \"JBD: failed to create handle cache\\n\");", 
"<span class=\"ts\"/><span class=\"ts\"/>return -<a class=\"id\" href=\"#ENOMEM\">ENOMEM</a>;", 
"<span class=\"ts\"/>}", 
"<span class=\"ts\"/>return 0;", 
"}", 
"", 
"static void <a class=\"id\" href=\"#journal_destroy_handle_cache\">journal_destroy_handle_cache</a>(void)", 
"{", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#jbd_handle_cache\">jbd_handle_cache</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#kmem_cache_destroy\">kmem_cache_destroy</a>(<a class=\"id\" href=\"#jbd_handle_cache\">jbd_handle_cache</a>);", 
"}", 
"", 
"<span class=\"comment\">/*</span>", 
"<span class=\"comment\"> * Module startup and shutdown</span>", 
"<span class=\"comment\"> */</span>", 
"", 
"static int <a class=\"id\" href=\"#__init\">__init</a> <a class=\"id\" href=\"#journal_init_caches\">journal_init_caches</a>(void)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#journal_init_revoke_caches\">journal_init_revoke_caches</a>();", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> == 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#journal_init_journal_head_cache\">journal_init_journal_head_cache</a>();", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> == 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#journal_init_handle_cache\">journal_init_handle_cache</a>();", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"", 
"static void <a class=\"id\" href=\"#journal_destroy_caches\">journal_destroy_caches</a>(void)", 
"{", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_destroy_revoke_caches\">journal_destroy_revoke_caches</a>();", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_destroy_journal_head_cache\">journal_destroy_journal_head_cache</a>();", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_destroy_handle_cache\">journal_destroy_handle_cache</a>();", 
"}", 
"", 
"static int <a class=\"id\" href=\"#__init\">__init</a> <a class=\"id\" href=\"#journal_init\">journal_init</a>(void)", 
"{", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#ret\">ret</a>;", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#BUILD_BUG_ON\">BUILD_BUG_ON</a>(sizeof(struct <a class=\"id\" href=\"#journal_superblock_s\">journal_superblock_s</a>) != 1024);", 
"", 
"<span class=\"ts\"/><a class=\"id\" href=\"#ret\">ret</a> = <a class=\"id\" href=\"#journal_init_caches\">journal_init_caches</a>();", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#ret\">ret</a> != 0)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#journal_destroy_caches\">journal_destroy_caches</a>();", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_create_debugfs_entry\">jbd_create_debugfs_entry</a>();", 
"<span class=\"ts\"/>return <a class=\"id\" href=\"#ret\">ret</a>;", 
"}", 
"", 
"static void <a class=\"id\" href=\"#__exit\">__exit</a> <a class=\"id\" href=\"#journal_exit\">journal_exit</a>(void)", 
"{", 
"#<a class=\"id\" href=\"#ifdef\">ifdef</a> <a class=\"id\" href=\"#CONFIG_JBD_DEBUG\">CONFIG_JBD_DEBUG</a>", 
"<span class=\"ts\"/>int <a class=\"id\" href=\"#n\">n</a> = <a class=\"id\" href=\"#atomic_read\">atomic_read</a>(&amp;<a class=\"id\" href=\"#nr_journal_heads\">nr_journal_heads</a>);", 
"<span class=\"ts\"/>if (<a class=\"id\" href=\"#n\">n</a>)", 
"<span class=\"ts\"/><span class=\"ts\"/><a class=\"id\" href=\"#printk\">printk</a>(<a class=\"id\" href=\"#KERN_EMERG\">KERN_EMERG</a> \"JBD: leaked %d journal_heads!\\n\", <a class=\"id\" href=\"#n\">n</a>);", 
"#<a class=\"id\" href=\"#endif\">endif</a>", 
"<span class=\"ts\"/><a class=\"id\" href=\"#jbd_remove_debugfs_entry\">jbd_remove_debugfs_entry</a>();", 
"<span class=\"ts\"/><a class=\"id\" href=\"#journal_destroy_caches\">journal_destroy_caches</a>();", 
"}", 
"", 
"<a class=\"id\" href=\"#MODULE_LICENSE\">MODULE_LICENSE</a>(\"GPL\");", 
"<a class=\"id\" href=\"#module_init\">module_init</a>(<a class=\"id\" href=\"#journal_init\">journal_init</a>);", 
"<a class=\"id\" href=\"#module_exit\">module_exit</a>(<a class=\"id\" href=\"#journal_exit\">journal_exit</a>);", 
"", 
];
xr_frag_insert('l/f3/6e354e66225d807a48022099a0b3350f7168b1.xr', __xr_tmp);
